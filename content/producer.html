
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>KafkaProducer · java-note</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="doctording">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-prism/prism.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-ace/ace.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-codeblock-filename/block.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search-plus/search.css">
                
            
                
                <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-sectionx/sectionx.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-tbfed-pagefooter/footer.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-back-to-top-button/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-code/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-page-treeview/style.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="producer2.html" />
    
    

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    Introduction
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.2" data-path="basic.html">
            
                <a href="basic.html">
            
                    
                    消息队列基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.3" data-path="kafka_basic.html">
            
                <a href="kafka_basic.html">
            
                    
                    kafka基础
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4" >
            
                <span>
            
                    
                    [kafka Producer]
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter active" data-level="1.4.1" data-path="producer.html">
            
                <a href="producer.html">
            
                    
                    KafkaProducer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.4.2" data-path="producer2.html">
            
                <a href="producer2.html">
            
                    
                    如何处理粘包/拆包问题
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.5" >
            
                <span>
            
                    
                    [kafka Broker & zookeeper]
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.5.1" data-path="broker.html">
            
                <a href="broker.html">
            
                    
                    kafka broker 理论知识
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.2" data-path="broker_kafkaapis.html">
            
                <a href="broker_kafkaapis.html">
            
                    
                    kafka broker 处理请求
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.5.3" data-path="broker_controller.html">
            
                <a href="broker_controller.html">
            
                    
                    controller & leader
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.6" >
            
                <span>
            
                    
                    [kafka Consumer]
            
                </span>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.6.1" data-path="consumer.html">
            
                <a href="consumer.html">
            
                    
                    constumer
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.2" data-path="consumer_offset.html">
            
                <a href="consumer_offset.html">
            
                    
                    __consumer_offsets
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.6.3" data-path="rebalance.html">
            
                <a href="rebalance.html">
            
                    
                    再平衡
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.7" data-path="pro.html">
            
                <a href="pro.html">
            
                    
                    kafka常见面试题
            
                </a>
            

            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >KafkaProducer</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div class="search-plus" id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div class="treeview__container"><div class="treeview__container-title"><span class="treeview__main-title">Treeview</span><span class="treeview__copyright">Copyright @doctording all right reserved, powered by <a href="https://github.com/aleen42" target="_blank">aleen42</a></span></div><ul>
<li><div><a href="#producer">Producer</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#topic&#x7684;&#x521B;&#x5EFA;&#x548C;&#x6570;&#x636E;&#x751F;&#x6210;&#x548C;&#x843D;&#x78C1;&#x76D8;&#x6587;&#x4EF6;">topic&#x7684;&#x521B;&#x5EFA;&#x548C;&#x6570;&#x636E;&#x751F;&#x6210;&#x548C;&#x843D;&#x78C1;&#x76D8;&#x6587;&#x4EF6;</a><i></i></div></li>
<li><div><a href="#&#x6D88;&#x606F;&#x8DEF;&#x7531;&#x5230;&#x4E0D;&#x540C;&#x7684;partition">&#x6D88;&#x606F;&#x8DEF;&#x7531;&#x5230;&#x4E0D;&#x540C;&#x7684;partition</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#&#x67E5;&#x770B;&#x78C1;&#x76D8;&#x4E0A;&#x7684;kafka-logs&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x4E0B;&#x5BF9;&#x5E94;&#x7684;topic&#x6587;&#x4EF6;">&#x67E5;&#x770B;&#x78C1;&#x76D8;&#x4E0A;&#x7684;kafka-logs&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x4E0B;&#x5BF9;&#x5E94;&#x7684;topic&#x6587;&#x4EF6;</a><i></i></div></li>
<li><div><a href="#topic&#x5206;partition&#x7684;&#x539F;&#x56E0;&#x4E0E;&#x5B9E;&#x73B0;">topic&#x5206;partition&#x7684;&#x539F;&#x56E0;&#x4E0E;&#x5B9E;&#x73B0;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#&#x5206;&#x533A;&#x7684;&#x539F;&#x56E0;">&#x5206;&#x533A;&#x7684;&#x539F;&#x56E0;</a><i></i></div></li>
<li><div><a href="#&#x751F;&#x4EA7;&#x8005;&#x53D1;&#x9001;&#x8FDB;&#x884C;&#x5206;&#x533A;&#x7684;&#x539F;&#x5219;&#xFF1F;">&#x751F;&#x4EA7;&#x8005;&#x53D1;&#x9001;&#x8FDB;&#x884C;&#x5206;&#x533A;&#x7684;&#x539F;&#x5219;&#xFF1F;</a><i></i></div></li>
</ul></li>
<li><div><a href="#producer&#x5982;&#x4F55;&#x5C06;&#x6D88;&#x606F;&#x53EF;&#x9760;&#x7684;&#x53D1;&#x9001;&#x7ED9;kafka&#x96C6;&#x7FA4;">Producer&#x5982;&#x4F55;&#x5C06;&#x6D88;&#x606F;&#x53EF;&#x9760;&#x7684;&#x53D1;&#x9001;&#x7ED9;Kafka&#x96C6;&#x7FA4;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#ack&#x5E94;&#x7B54;&#x673A;&#x5236;&#xFF08;3&#x79CD;&#x7B56;&#x7565;&#xFF09;">ack&#x5E94;&#x7B54;&#x673A;&#x5236;&#xFF08;3&#x79CD;&#x7B56;&#x7565;&#xFF09;</a><i></i></div></li>
<li><div><a href="#retries">retries</a><i></i></div></li>
<li><div><a href="#batchsize">batch.size</a><i></i></div></li>
<li><div><a href="#lingerms">linger.ms</a><i></i></div></li>
<li><div><a href="#requeststimeoutms">requests.timeout.ms</a><i></i></div></li>
<li><div><a href="#maxinflightrequestsperconnection">max.in.flight.requests.per.connection</a><i></i></div></li>
</ul></li>
<li><div><a href="#isr-&#x673A;&#x5236;-&#x548C;-&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;">ISR &#x673A;&#x5236; &#x548C; &#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#leo--hw-&#x4FDD;&#x8BC1;&#x526F;&#x672C;&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;">LEO &amp; HW &#x4FDD;&#x8BC1;&#x526F;&#x672C;&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;</a><i></i></div></li>
<li><div><a href="#follower&#x6545;&#x969C;">follower&#x6545;&#x969C;</a><i></i></div></li>
<li><div><a href="#leader&#x6545;&#x969C;">leader&#x6545;&#x969C;</a><i></i></div></li>
</ul></li>
<li><div><a href="#011&#x7248;&#x672C;&#x4E4B;&#x540E;-&#x5E42;&#x7B49;--exactly-once-&#x8BED;&#x4E49;">0.11&#x7248;&#x672C;&#x4E4B;&#x540E; &#x5E42;&#x7B49; &amp; Exactly Once &#x8BED;&#x4E49;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#&#x4E8B;&#x52A1;&#x5E94;&#x7528;&#x573A;&#x666F;">&#x4E8B;&#x52A1;&#x5E94;&#x7528;&#x573A;&#x666F;</a><i></i></div></li>
<li><div><a href="#&#x4E8B;&#x52A1;&#x5904;&#x7406;">&#x4E8B;&#x52A1;&#x5904;&#x7406;</a><i></i></div></li>
</ul></li>
</ul></li>
<li><div><a href="#kafkaproducer&#x6E90;&#x7801;">KafkaProducer&#x6E90;&#x7801;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#kafkaproducer-&#x4EA4;&#x4E92;&#x7B80;&#x56FE;">KafkaProducer &#x4EA4;&#x4E92;&#x7B80;&#x56FE;</a><i></i></div></li>
<li><div><a href="#&#x6E90;&#x7801;&#x6D41;&#x7A0B;&#x56FE;">&#x6E90;&#x7801;&#x6D41;&#x7A0B;&#x56FE;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#&#x5143;&#x6570;&#x636E;&#x4EA4;&#x4E92;">&#x5143;&#x6570;&#x636E;&#x4EA4;&#x4E92;</a><i></i></div></li>
<li><div><a href="#&#x5143;&#x6570;&#x636E;&#x66F4;&#x65B0;&#x91CD;&#x96BE;&#x70B9;">&#x5143;&#x6570;&#x636E;&#x66F4;&#x65B0;&#x91CD;&#x96BE;&#x70B9;</a><i></i></div></li>
<li><div><a href="#&#x5E8F;&#x5217;&#x5316;">&#x5E8F;&#x5217;&#x5316;</a><i></i></div></li>
<li><div><a href="#&#x8BA1;&#x7B97;-record-&#x8981;&#x53D1;&#x9001;&#x5230;&#x7684;-partition&#xFF1F;">&#x8BA1;&#x7B97; record &#x8981;&#x53D1;&#x9001;&#x5230;&#x7684; partition&#xFF1F;</a><i></i></div></li>
<li><div><a href="#accumulatorappend">accumulator.append()</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#recordaccumulator">RecordAccumulator</a><i></i></div></li>
<li><div><a href="#append&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x7801;&#x6D41;&#x7A0B;">append&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x7801;&#x6D41;&#x7A0B;</a><i></i></div></li>
</ul></li>
<li><div><a href="#sender&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x6D41;&#x7A0B;">sender&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x6D41;&#x7A0B;</a><i class="level__parent level__item level__parent--opened" state="opened" onclick="var curState = this.getAttribute(&apos;state&apos;);var nextState = curState === &apos;opened&apos; ? &apos;hidden&apos; : &apos;opened&apos;;this.setAttribute(&apos;state&apos;, nextState);this.className = this.className.split(curState).join(nextState);var list = this.parentNode.nextElementSibling;if (nextState === &apos;hidden&apos;) {    list.style.display = &apos;none&apos;;} else {    list.style.display = &apos;block&apos;;}"></i></div>
<ul>
<li><div><a href="#sender&#x6E90;&#x7801;">sender&#x6E90;&#x7801;</a><i></i></div></li>
<li><div><a href="#sendproducerdata">sendProducerData</a><i></i></div></li>
<li><div><a href="#&#x8D85;&#x65F6;&#x6D88;&#x606F;&#x7684;&#x5904;&#x7406;">&#x8D85;&#x65F6;&#x6D88;&#x606F;&#x7684;&#x5904;&#x7406;</a><i></i></div></li>
<li><div><a href="#clientpoll">client.poll</a><i></i></div></li>
</ul></li>
</ul></li>
</ul></li>
</ul></li>
</ul>
</div>

<h1 id="producer">Producer</h1>
<h2 id="topic&#x7684;&#x521B;&#x5EFA;&#x548C;&#x6570;&#x636E;&#x751F;&#x6210;&#x548C;&#x843D;&#x78C1;&#x76D8;&#x6587;&#x4EF6;">topic&#x7684;&#x521B;&#x5EFA;&#x548C;&#x6570;&#x636E;&#x751F;&#x6210;&#x548C;&#x843D;&#x78C1;&#x76D8;&#x6587;&#x4EF6;</h2>
<ul>
<li>&#x521B;&#x5EFA;topic&#x540D;&#x79F0;&#x4E3A;&#xFF1A;<code>kafkatest</code></li>
</ul>
<p><img src="../imgs/topic_create.png" alt=""></p>
<ul>
<li>&#x4E09;&#x53F0;broker(0,1,2), &#x8BBE;&#x7F6E;topic&#x7684;partition&#x6570;&#x76EE;&#x662F;2&#xFF0C;replication&#x5907;&#x4EFD;&#x56E0;&#x5B50;&#x662F;2<ol>
<li>&#x5BF9;&#x4E8E;partition 0&#xFF0C;leader &#x662F; 3&#xFF0C;follower &#x662F; 1&#xFF0C;&#x4E24;&#x4E2A;&#x5907;&#x4EFD;</li>
<li>&#x5BF9;&#x4E8E;partition 1&#xFF0C;leader &#x662F; 1&#xFF0C;follower &#x662F; 2&#xFF0C;&#x4E24;&#x4E2A;&#x5907;&#x4EFD;</li>
</ol>
</li>
</ul>
<p><img src="../imgs/topic_create_2.png" alt=""></p>
<p>&#x4E00;&#x6B21;&#x53D1;&#x9001;&#x4E86;4&#x6761;&#x6D88;&#x606F;&#xFF0C;&#x5185;&#x5BB9;&#x5206;&#x522B;&#x662F;</p>
<pre class="language-"><code class="lang-java">&#x7A7A;
a1
b1
c1
</code></pre>
<h2 id="&#x6D88;&#x606F;&#x8DEF;&#x7531;&#x5230;&#x4E0D;&#x540C;&#x7684;partition">&#x6D88;&#x606F;&#x8DEF;&#x7531;&#x5230;&#x4E0D;&#x540C;&#x7684;partition</h2>
<ul>
<li><code>&#x7A7A;</code>&#x548C;<code>b1</code>&#x5B58;&#x50A8;&#x5230;&#x4E86;<code>partition 0</code>&#x4E2D;</li>
<li><code>a1</code>&#x548C;<code>c1</code>&#x5B58;&#x50A8;&#x5230;&#x4E86;<code>partition 1</code>&#x4E2D;</li>
</ul>
<p><img src="../imgs/topic_create_3.png" alt=""></p>
<p><img src="../imgs/topic_create_4.png" alt=""></p>
<h3 id="&#x67E5;&#x770B;&#x78C1;&#x76D8;&#x4E0A;&#x7684;kafka-logs&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x4E0B;&#x5BF9;&#x5E94;&#x7684;topic&#x6587;&#x4EF6;">&#x67E5;&#x770B;&#x78C1;&#x76D8;&#x4E0A;&#x7684;<code>kafka-logs</code>&#x6587;&#x4EF6;&#x76EE;&#x5F55;&#x4E0B;&#x5BF9;&#x5E94;&#x7684;topic&#x6587;&#x4EF6;</h3>
<ol>
<li>&#x5BF9;&#x4E8E;partition 0&#xFF0C;leader &#x662F; 3&#xFF0C;follower &#x662F; 1</li>
<li>&#x5BF9;&#x4E8E;partition 1&#xFF0C;leader &#x662F; 1&#xFF0C;follower &#x662F; 2</li>
</ol>
<p>&#x767B;&#x5F55;&#x5230;&#x4E09;&#x53F0;&#x673A;&#x5668;&#x5206;&#x522B;&#x67E5;&#x770B;</p>
<ul>
<li>broker 1</li>
</ul>
<p>&#x5305;&#x542B;&#x4E86;<code>kafkatest-0</code>&#x548C;<code>kafkatest-1</code>&#x4E24;&#x4E2A;&#x76EE;&#x5F55;&#x6587;&#x4EF6;</p>
<p><img src="../imgs/b1.png" alt=""></p>
<ul>
<li>broker 2</li>
</ul>
<p>&#x53EA;&#x5305;&#x542B;<code>kafkatest-1</code>&#x4E24;&#x4E2A;&#x76EE;&#x5F55;&#x6587;&#x4EF6;</p>
<p><img src="../imgs/b2.png" alt=""></p>
<ul>
<li>broker 3</li>
</ul>
<p>&#x53EA;&#x5305;&#x542B;<code>kafkatest-0</code>&#x4E24;&#x4E2A;&#x76EE;&#x5F55;&#x6587;&#x4EF6;</p>
<p><img src="../imgs/b3.png" alt=""></p>
<h3 id="topic&#x5206;partition&#x7684;&#x539F;&#x56E0;&#x4E0E;&#x5B9E;&#x73B0;">topic&#x5206;partition&#x7684;&#x539F;&#x56E0;&#x4E0E;&#x5B9E;&#x73B0;</h3>
<h4 id="&#x5206;&#x533A;&#x7684;&#x539F;&#x56E0;">&#x5206;&#x533A;&#x7684;&#x539F;&#x56E0;</h4>
<ol>
<li>&#x65B9;&#x4FBF;&#x5728;&#x96C6;&#x7FA4;&#x4E2D;&#x6269;&#x5C55;&#xFF0C;&#x6BCF;&#x4E2A;Partition&#x53EF;&#x4EE5;&#x901A;&#x8FC7;&#x8C03;&#x6574;&#x4EE5;&#x9002;&#x5E94;&#x5B83;&#x6240;&#x5728;&#x7684;&#x673A;&#x5668;&#xFF0C;&#x800C;&#x4E00;&#x4E2A;topic&#x53C8;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;Partition&#x7EC4;&#x6210;&#xFF0C;&#x56E0;&#x6B64;&#x6574;&#x4E2A;&#x96C6;&#x7FA4;&#x5C31;&#x53EF;&#x4EE5;&#x9002;&#x5E94;&#x4EFB;&#x610F;&#x5927;&#x5C0F;&#x7684;&#x6570;&#x636E;&#x4E86;</li>
<li>&#x53EF;&#x4EE5;&#x63D0;&#x9AD8;&#x5E76;&#x53D1;&#xFF0C;&#x56E0;&#x4E3A;&#x53EF;&#x4EE5;&#x4EE5;Partition&#x4E3A;&#x5355;&#x4F4D;&#x8BFB;&#x5199;&#x4E86;</li>
</ol>
<h4 id="&#x751F;&#x4EA7;&#x8005;&#x53D1;&#x9001;&#x8FDB;&#x884C;&#x5206;&#x533A;&#x7684;&#x539F;&#x5219;&#xFF1F;">&#x751F;&#x4EA7;&#x8005;&#x53D1;&#x9001;&#x8FDB;&#x884C;&#x5206;&#x533A;&#x7684;&#x539F;&#x5219;&#xFF1F;</h4>
<p>&#x6211;&#x4EEC;&#x9700;&#x8981;&#x5C06;producer&#x53D1;&#x9001;&#x7684;&#x6570;&#x636E;&#x5C01;&#x88C5;&#x6210;&#x4E00;&#x4E2A;ProducerRecord&#x5BF9;&#x8C61;&#xFF0C;&#x7136;&#x540E;&#x53D1;&#x9001;</p>
<ol>
<li>&#x6307;&#x660E; partition &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x76F4;&#x63A5;&#x5C06;&#x6307;&#x660E;&#x7684;&#x503C;&#x76F4;&#x63A5;&#x4F5C;&#x4E3A;&#x8981;&#x53D1;&#x9001;&#x7684; partiton &#x503C;&#xFF1B;</li>
<li>&#x6CA1;&#x6709;&#x6307;&#x660E; partition &#x503C;&#x4F46;&#x6709; key &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5C06; key &#x7684; hash &#x503C;&#x4E0E;topic&#x7684;partition&#x603B;&#x6570;&#x8FDB;&#x884C;&#x53D6;&#x4F59;&#x5F97;&#x5230;&#x4E00;&#x4E2A; partition &#x503C;&#xFF1B;</li>
<li>&#x65E2;&#x6CA1;&#x6709; partition &#x503C;&#x53C8;&#x6CA1;&#x6709; key &#x503C;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&#x65F6;&#x968F;&#x673A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x6574;&#x6570;&#xFF08;&#x540E;&#x9762;&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x5728;&#x8FD9;&#x4E2A;&#x6574;&#x6570;&#x4E0A;&#x81EA;&#x589E;&#xFF09;&#xFF0C;&#x5C06;&#x8FD9;&#x4E2A;&#x503C;&#x4E0E; topic &#x53EF;&#x7528;&#x7684; partition &#x603B;&#x6570;<strong>&#x53D6;&#x4F59;</strong>&#x5F97;&#x5230; partition &#x503C;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x5E38;&#x8BF4;&#x7684; round-robin &#x7B97;&#x6CD5;&#xFF08;&#x8F6E;&#x8BE2;&#xFF09;&#x3002;</li>
</ol>
<h3 id="producer&#x5982;&#x4F55;&#x5C06;&#x6D88;&#x606F;&#x53EF;&#x9760;&#x7684;&#x53D1;&#x9001;&#x7ED9;kafka&#x96C6;&#x7FA4;">Producer&#x5982;&#x4F55;&#x5C06;&#x6D88;&#x606F;&#x53EF;&#x9760;&#x7684;&#x53D1;&#x9001;&#x7ED9;Kafka&#x96C6;&#x7FA4;</h3>
<h4 id="ack&#x5E94;&#x7B54;&#x673A;&#x5236;&#xFF08;3&#x79CD;&#x7B56;&#x7565;&#xFF09;">ack&#x5E94;&#x7B54;&#x673A;&#x5236;&#xFF08;3&#x79CD;&#x7B56;&#x7565;&#xFF09;</h4>
<p>acks&#x6307;&#x5B9A;&#x4E86;&#x5FC5;&#x987B;&#x6709;&#x591A;&#x5C11;&#x4E2A;&#x5206;&#x533A;&#x526F;&#x672C;&#x63A5;&#x6536;&#x5230;&#x4E86;&#x6D88;&#x606F;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x624D;&#x4F1A;&#x8BA4;&#x4E3A;&#x6D88;&#x606F;&#x662F;&#x53D1;&#x9001;&#x6210;&#x529F;&#x7684;&#x3002;</p>
<ol>
<li>acks=0&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x6210;&#x529F;&#x5199;&#x5165;&#x6D88;&#x606F;&#x4E4B;&#x524D;&#x4E0D;&#x4F1A;&#x7B49;&#x5F85;&#x6765;&#x81EA;&#x4EFB;&#x4F55;&#x670D;&#x52A1;&#x5668;&#x7684;&#x54CD;&#x5E94;&#xFF0C;&#x8FD9;&#x79CD;&#x914D;&#x7F6E;&#xFF0C;&#x63D0;&#x9AD8;&#x541E;&#x5410;&#x91CF;&#xFF0C;&#x4F46;&#x662F;&#x6D88;&#x606F;&#x5B58;&#x5728;&#x4E22;&#x5931;&#x98CE;&#x9669;&#x3002;</li>
<li>acks=1&#xFF0C;&#x53EA;&#x8981;&#x96C6;&#x7FA4;&#x7684;leader&#xFF08;master&#xFF09;&#x6536;&#x5230;&#x4E86;&#x6D88;&#x606F;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x5C06;&#x4F1A;&#x53D7;&#x5230;&#x53D1;&#x9001;&#x6210;&#x529F;&#x7684;&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#xFF0C;&#x5982;&#x679C;&#x6D88;&#x606F;&#x65E0;&#x649E;&#x5230;&#x8FBE;&#x9996;&#x9886;&#x8282;&#x70B9;&#xFF08;&#x6BD4;&#x5982;&#x9996;&#x9886;&#x8282;&#x70B9;&#x5D29;&#x6E83;&#xFF0C;&#x65B0;&#x7684;&#x9996;&#x9886;&#x8FD8;&#x6CA1;&#x6709;&#x88AB;&#x9009;&#x4E3E;&#x51FA;&#x6765;&#xFF09;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x4F1A;&#x6536;&#x5230;&#x4E00;&#x4E2A;&#x9519;&#x8BEF;&#x54CD;&#x5E94;&#xFF0C;&#x4E3A;&#x4E86;&#x907F;&#x514D;&#x6570;&#x636E;&#x4E22;&#x5931;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x4F1A;&#x91CD;&#x53D1;&#x6D88;&#x606F;&#x3002;&#x4E0D;&#x8FC7;&#xFF0C;&#x5982;&#x679C;&#x4E00;&#x4E2A;&#x6CA1;&#x6709;&#x6536;&#x5230;&#x6D88;&#x606F;&#x7684;&#x8282;&#x70B9;&#x6210;&#x4E3A;&#x65B0;&#x9996;&#x9886;&#xFF0C;&#x6D88;&#x606F;&#x8FD8;&#x662F;&#x4F1A;&#x4E22;&#x5931;&#x3002;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x7684;&#x541E;&#x5410;&#x91CF;&#x53D6;&#x51B3;&#x4E8E;&#x4F7F;&#x7528;&#x7684;&#x662F;&#x540C;&#x6B65;&#x53D1;&#x9001;&#x8FD8;&#x662F;&#x5F02;&#x6B65;&#x53D1;&#x9001;&#x3002;&#x5982;&#x679C;&#x8BA9;&#x53D1;&#x9001;&#x5BA2;&#x6237;&#x7AEF;&#x7B49;&#x5F85;&#x670D;&#x52A1;&#x5668;&#x7684;&#x54CD;&#x5E94;&#xFF08;&#x901A;&#x8FC7;&#x8C03;&#x7528;Future &#x5BF9;&#x8C61;&#x7684;get&#xFF08;&#xFF09;&#x65B9;&#x6CD5;&#xFF0C;&#x663E;&#x7136;&#x4F1A;&#x589E;&#x52A0;&#x5EF6;&#x8FDF;&#xFF08;&#x5728;&#x7F51;&#x7EDC;&#x4E0A;&#x4F20;&#x8F93;&#x4E00;&#x4E2A;&#x6765;&#x56DE;&#x7684;&#x5EF6;&#x8FDF;&#xFF09;&#x3002;&#x5982;&#x679C;&#x5BA2;&#x6237;&#x7AEF;&#x4F7F;&#x7528;&#x56DE;&#x8C03;&#xFF0C;&#x5EF6;&#x8FDF;&#x95EE;&#x9898;&#x5C31;&#x53EF;&#x4EE5;&#x5F97;&#x5230;&#x7F13;&#x89E3;&#xFF0C;&#x4E0D;&#x8FC7;&#x541E;&#x5410;&#x91CF;&#x8FD8;&#x662F;&#x4F1A;&#x53D7;&#x53D1;&#x9001;&#x4E2D;&#x6D88;&#x606F;&#x6570;&#x91CF;&#x7684;&#x9650;&#x5236;&#xFF08;&#x6BD4;&#x5982;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x5728;&#x6536;&#x5230;&#x670D;&#x52A1;&#x5668;&#x54CD;&#x5E94;&#x4E4B;&#x524D;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x591A;&#x5C11;&#x4E2A;&#x6D88;&#x606F;&#xFF09;&#x3002;</li>
<li>acks=-1&#xFF0C;&#x6240;&#x6709;&#x53C2;&#x4E0E;&#x590D;&#x5236;&#x7684;&#x8282;&#x70B9;&#x5168;&#x90E8;&#x6536;&#x5230;&#x6D88;&#x606F;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x624D;&#x4F1A;&#x6536;&#x5230;&#x6765;&#x81EA;&#x670D;&#x52A1;&#x5668;&#x7684;&#x4E00;&#x4E2A;&#x54CD;&#x5E94;&#xFF0C;&#x8FD9;&#x79CD;&#x6A21;&#x5F0F;&#x6700;&#x5B89;&#x5168;&#xFF0C;&#x4F46;&#x662F;&#x541E;&#x5410;&#x91CF;&#x53D7;&#x9650;&#x5236;&#xFF0C;&#x5B83;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x4E0D;&#x6B62;&#x4E00;&#x4E2A;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x6D88;&#x606F;&#xFF0C;&#x5C31;&#x7B97;&#x67D0;&#x53F0;&#x670D;&#x52A1;&#x5668;&#x5954;&#x6E83;&#xFF0C;&#x90A3;&#x4E48;&#x6574;&#x4E2A;&#x96C6;&#x7FA4;&#x8FD8;&#x662F;&#x4F1A;&#x6B63;&#x4EA7;&#x8FD0;&#x8F6C;&#x3002;</li>
</ol>
<h4 id="retries">retries</h4>
<p>&#x751F;&#x4EA7;&#x8005;&#x4ECE;&#x670D;&#x52A1;&#x5668;&#x6536;&#x5230;&#x7684;&#x9519;&#x8BEF;&#x6D88;&#x606F;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x4E34;&#x65F6;&#x7684;&#xFF0C;&#x5F53;&#x751F;&#x4EA7;&#x8005;&#x6536;&#x5230;&#x670D;&#x52A1;&#x5668;&#x53D1;&#x6765;&#x7684;&#x9519;&#x8BEF;&#x6D88;&#x606F;&#xFF0C;&#x4F1A;&#x542F;&#x52A8;&#x91CD;&#x8BD5;&#x673A;&#x5236;&#xFF0C;&#x5F53;&#x91CD;&#x8BD5;&#x4E86;n&#xFF08;&#x8BBE;&#x7F6E;&#x7684;&#x503C;&#xFF09;&#x6B21;&#xFF0C;&#x8FD8;&#x662F;&#x6536;&#x5230;&#x9519;&#x8BEF;&#x6D88;&#x606F;&#xFF0C;&#x90A3;&#x4E48;&#x5C06;&#x4F1A;&#x8FD4;&#x56DE;&#x9519;&#x8BEF;&#x3002;&#x751F;&#x4EA7;&#x8005;&#x4F1A;&#x5728;&#x6BCF;&#x6B21;&#x91CD;&#x8BD5;&#x4E4B;&#x95F4;&#x95F4;&#x9694;100ms&#xFF0C;&#x4E0D;&#x8FC7;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;<code>retry.backoff.ms</code>&#x6539;&#x53D8;&#x8FD9;&#x4E2A;&#x95F4;&#x9694;&#x3002;</p>
<h4 id="batchsize">batch.size</h4>
<p>&#x5F53;&#x591A;&#x4E2A;&#x6D88;&#x606F;&#x53D1;&#x5F80;&#x540C;&#x4E00;&#x4E2A;&#x5206;&#x533A;&#xFF0C;&#x751F;&#x4EA7;&#x8005;&#x4F1A;&#x5C06;&#x4ED6;&#x4EEC;&#x653E;&#x8FDB;&#x540C;&#x4E00;&#x4E2A;&#x6279;&#x6B21;&#xFF0C;&#x8BE5;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x4E86;&#x4E00;&#x4E2A;&#x6279;&#x6B21;&#x53EF;&#x4EE5;&#x4F7F;&#x7528;&#x7684;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#xFF0C;&#x6309;&#x7167;&#x5B57;&#x8282;&#x6570;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;(&#x4E0D;&#x662F;&#x6D88;&#x606F;&#x4E2A;&#x6570;)&#xFF1B;&#x5F53;&#x6279;&#x6B21;&#x88AB;&#x586B;&#x6EE1;&#xFF0C;&#x6279;&#x6B21;&#x91CC;&#x9762;&#x6240;&#x6709;&#x5F97;&#x6D88;&#x606F;&#x5C06;&#x4F1A;&#x88AB;&#x53D1;&#x9001;&#xFF1B;&#x534A;&#x6EE1;&#x7684;&#x6279;&#x6B21;&#xFF0C;&#x751A;&#x81F3;&#x53EA;&#x5305;&#x542B;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x4E5F;&#x53EF;&#x80FD;&#x4F1A;&#x88AB;&#x53D1;&#x9001;&#xFF0C;&#x6240;&#x4EE5;&#x5373;&#x4F7F;&#x628A;&#x6279;&#x6B21;&#x8BBE;&#x7F6E;&#x7684;&#x5F88;&#x5927;&#xFF0C;&#x4E5F;&#x4E0D;&#x4F1A;&#x9020;&#x6210;&#x5EF6;&#x8FDF;&#xFF0C;&#x53EA;&#x662F;&#x5360;&#x7528;&#x7684;&#x5185;&#x5B58;&#x6253;&#x4E86;&#x4E00;&#x4E9B;&#x800C;&#x5DF2;&#x3002;&#x4F46;&#x662F;&#x8BBE;&#x7F6E;&#x7684;&#x592A;&#x5C0F;&#xFF0C;&#x90A3;&#x4E48;&#x751F;&#x4EA7;&#x8005;&#x5C06;&#x4F1A;&#x9891;&#x7E41;&#x7684;&#x53D1;&#x9001;&#x5C0F;&#xFF0C;&#x589E;&#x52A0;&#x4E00;&#x4E9B;&#x989D;&#x5916;&#x7684;&#x5F00;&#x9500;&#x3002;</p>
<h4 id="lingerms">linger.ms</h4>
<p>&#x8BE5;&#x53C2;&#x6570;&#x6307;&#x5B9A;&#x4E86;&#x751F;&#x4EA7;&#x8005;&#x5728;&#x53D1;&#x9001;&#x6279;&#x6B21;&#x4E4B;&#x524D;&#x7B49;&#x5F85;&#x66F4;&#x591A;&#x6D88;&#x606F;&#x52A0;&#x5165;&#x6279;&#x6B21;&#x7684;&#x65F6;&#x95F4;&#x3002;KafkaProducer&#x4F1A;&#x5728;&#x6279;&#x6B21;&#x586B;&#x6EE1;&#x6216;linger.ms&#x8FBE;&#x5230;&#x4E0A;&#x9650;&#x65F6;&#x628A;&#x6279;&#x6B21;&#x53D1;&#x9001;&#x51FA;&#x53BB;&#x3002;&#x9ED8;&#x8BA4;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EA;&#x8981;&#x6709;&#x53EF;&#x7528;&#x7684;&#x7EBF;&#x7A0B;&#xFF0C; &#x751F;&#x4EA7;&#x8005;&#x5C31;&#x4F1A;&#x628A;&#x6D88;&#x606F;&#x53D1;&#x9001;&#x51FA;&#x53BB;&#xFF0C;&#x5C31;&#x7B97;&#x6279;&#x6B21;&#x91CC;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x6D88;&#x606F;&#x3002;&#x628A;linger.ms&#x8BBE;&#x7F6E;&#x6210;&#x6BD4;0&#x5927;&#x7684;&#x6570;&#xFF0C;&#x8BA9;&#x751F;&#x4EA7;&#x8005;&#x5728;&#x53D1;&#x9001;&#x6279;&#x6B21;&#x4E4B;&#x524D;&#x7B49;&#x5F85;&#x4E00;&#x4F1A;&#x513F;&#xFF0C;&#x4F7F;&#x66F4;&#x591A;&#x7684;&#x6D88;&#x606F;&#x52A0;&#x5165;&#x5230;&#x8FD9;&#x4E2A;&#x6279;&#x6B21;&#x3002;&#x867D;&#x7136;&#x8FD9;&#x6837;&#x4F1A;&#x589E;&#x52A0;&#x5EF6;&#x8FDF;&#xFF0C;&#x4F46;&#x4E5F;&#x4F1A;&#x63D0;&#x5347;&#x541E;&#x5410;&#x91CF;&#xFF08;&#x56E0;&#x4E3A;&#x4E00;&#x6B21;&#x6027;&#x53D1;&#x9001;&#x66F4;&#x591A;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x6BCF;&#x4E2A;&#x6D88;&#x606F;&#x7684;&#x5F00;&#x9500;&#x5C31;&#x53D8;&#x5C0F;&#x4E86;&#xFF09;</p>
<h4 id="requeststimeoutms">requests.timeout.ms</h4>
<p>&#x751F;&#x4EA7;&#x8005;&#x53D1;&#x9001;&#x6570;&#x636E;&#x65F6;&#x7B49;&#x5F85;&#x670D;&#x52A1;&#x5668;&#x8FD4;&#x56DE;&#x54CD;&#x5E94;&#x7684;&#x65F6;&#x95F4;</p>
<h4 id="maxinflightrequestsperconnection">max.in.flight.requests.per.connection</h4>
<p>&#x6307;&#x5B9A;&#x4E86;&#x751F;&#x4EA7;&#x8005;&#x6536;&#x5230;&#x670D;&#x52A1;&#x5668;&#x54CD;&#x5E94;&#x4E4B;&#x524D;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x591A;&#x5C11;&#x4E2A;&#x6D88;&#x606F;&#x3002;&#x5B83;&#x7684;&#x503C;&#x8D8A;&#x9AD8;&#xFF0C;&#x5C06;&#x4F1A;&#x6D88;&#x8017;&#x66F4;&#x591A;&#x7684;&#x5185;&#x5B58;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E5F;&#x4F1A;&#x63D0;&#x5347;&#x541E;&#x5410;&#x91CF;&#x3002;&#x8BBE;&#x7F6E;&#x4E3A;1&#xFF0C;&#x53EF;&#x4EE5;&#x4FDD;&#x8BC1;&#x6D88;&#x606F;&#x662F;&#x6309;&#x7167;&#x53D1;&#x9001;&#x7684;&#x987A;&#x5E8F;&#x5199;&#x5165;&#x670D;&#x52A1;&#x5668;&#x3002;&#x5373;&#x4F7F;&#x53D1;&#x751F;&#x4E86;&#x91CD;&#x8BD5;&#x3002;</p>
<h3 id="isr-&#x673A;&#x5236;-&#x548C;-&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;">ISR &#x673A;&#x5236; &#x548C; &#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;</h3>
<p>Leader&#x7EF4;&#x62A4;&#x4E86;&#x4E00;&#x4E2A;&#x52A8;&#x6001;&#x7684;in-sync replica set (ISR)&#xFF0C;&#x610F;&#x4E3A;&#x548C;leader&#x4FDD;&#x6301;&#x540C;&#x6B65;&#x7684;follower&#x96C6;&#x5408;&#x3002;&#x5F53;ISR&#x4E2D;&#x7684;follower&#x5B8C;&#x6210;&#x6570;&#x636E;&#x7684;&#x540C;&#x6B65;&#x4E4B;&#x540E;&#xFF0C;leader&#x5C31;&#x4F1A;&#x7ED9;follower&#x53D1;&#x9001;ack&#x3002;&#x5982;&#x679C;follower&#x957F;&#x65F6;&#x95F4;&#x672A;&#x5411;leader&#x540C;&#x6B65;&#x6570;&#x636E;&#xFF0C;&#x5219;&#x8BE5;follower&#x5C06;&#x88AB;&#x8E22;&#x51FA;ISR&#xFF0C;&#x8BE5;&#x65F6;&#x95F4;&#x9608;&#x503C;&#x7531;replica.lag.time.max.ms&#x53C2;&#x6570;&#x8BBE;&#x5B9A;&#x3002;Leader&#x53D1;&#x751F;&#x6545;&#x969C;&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x4F1A;&#x4ECE;ISR&#x4E2D;&#x9009;&#x4E3E;&#x65B0;&#x7684;leader</p>
<font color="red">Kafka &#x7684;&#x590D;&#x5236;&#x673A;&#x5236;&#x65E2;&#x4E0D;&#x662F;&#x5B8C;&#x5168;&#x7684;&#x540C;&#x6B65;&#x590D;&#x5236;&#xFF0C;&#x4E5F;&#x4E0D;&#x662F;&#x5355;&#x7EAF;&#x7684;&#x5F02;&#x6B65;&#x590D;&#x5236;</font>&#x3002;&#x5B8C;&#x5168;&#x540C;&#x6B65;&#x590D;&#x5236;&#x8981;&#x6C42;&#x6240;&#x6709;&#x80FD;&#x5DE5;&#x4F5C;&#x7684; Follower &#x90FD;&#x590D;&#x5236;&#x5B8C;&#xFF0C;&#x8FD9;&#x6761;&#x6D88;&#x606F;&#x624D;&#x4F1A;&#x88AB;&#x8BA4;&#x4E3A; commit&#xFF0C;&#x8FD9;&#x79CD;&#x590D;&#x5236;&#x65B9;&#x5F0F;&#x6781;&#x5927;&#x7684;&#x5F71;&#x54CD;&#x4E86;&#x541E;&#x5410;&#x7387;&#xFF08;&#x9AD8;&#x541E;&#x5410;&#x7387;&#x662F; Kafka &#x975E;&#x5E38;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x7279;&#x6027;&#xFF09;&#x3002;&#x800C;&#x5F02;&#x6B65;&#x590D;&#x5236;&#x65B9;&#x5F0F;&#x4E0B;&#xFF0C;Follower &#x5F02;&#x6B65;&#x7684;&#x4ECE; Leader &#x590D;&#x5236;&#x6570;&#x636E;&#xFF0C;&#x6570;&#x636E;&#x53EA;&#x8981;&#x88AB; Leader &#x5199;&#x5165; log &#x5C31;&#x88AB;&#x8BA4;&#x4E3A;&#x5DF2;&#x7ECF; commit&#xFF0C;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x4E0B;&#x5982;&#x679C; Follower &#x90FD;&#x590D;&#x5236;&#x5B8C;&#x90FD;&#x843D;&#x540E;&#x4E8E; Leader&#xFF0C;&#x800C;&#x5982;&#x679C; Leader &#x7A81;&#x7136;&#x5B95;&#x673A;&#xFF0C;&#x5219;&#x4F1A;&#x4E22;&#x5931;&#x6570;&#x636E;&#x3002;

#### LEO &amp; HW &#x4FDD;&#x8BC1;&#x526F;&#x672C;&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;

* LEO&#xFF1A;&#x6307;&#x7684;&#x662F;&#x6BCF;&#x4E2A;&#x526F;&#x672C;&#x6700;&#x5927;&#x7684;offset
* HW&#xFF1A;&#x6307;&#x7684;&#x662F;&#x6D88;&#x8D39;&#x8005;&#x80FD;&#x89C1;&#x5230;&#x7684;&#x6700;&#x5927;&#x7684;offset&#xFF0C;ISR&#x961F;&#x5217;&#x4E2D;&#x6700;&#x5C0F;&#x7684;LEO

![](../imgs/hw_leo.png)

![](../imgs/hw_leo2.jpeg)

#### follower&#x6545;&#x969C;

follower&#x53D1;&#x751F;&#x6545;&#x969C;&#x540E;&#x4F1A;&#x88AB;&#x4E34;&#x65F6;&#x8E22;&#x51FA;ISR&#xFF0C;&#x5F85;&#x8BE5;follower&#x6062;&#x590D;&#x540E;&#xFF0C;follower&#x4F1A;&#x8BFB;&#x53D6;&#x672C;&#x5730;&#x78C1;&#x76D8;&#x8BB0;&#x5F55;&#x7684;&#x4E0A;&#x6B21;&#x7684;HW&#xFF0C;&#x5E76;&#x5C06;log&#x6587;&#x4EF6;&#x9AD8;&#x4E8E;HW&#x7684;&#x90E8;&#x5206;&#x622A;&#x53D6;&#x6389;&#xFF0C;&#x4ECE;HW&#x5F00;&#x59CB;&#x5411;leader&#x8FDB;&#x884C;&#x540C;&#x6B65;&#x3002;&#x7B49;&#x8BE5;follower&#x7684;LEO&#x5927;&#x4E8E;&#x7B49;&#x4E8E;&#x8BE5;Partition&#x7684;HW&#xFF0C;&#x5373;follower&#x8FFD;&#x4E0A;leader&#x4E4B;&#x540E;&#xFF0C;&#x5C31;&#x53EF;&#x4EE5;&#x91CD;&#x65B0;&#x52A0;&#x5165;ISR&#x4E86;&#x3002;

#### leader&#x6545;&#x969C;

leader&#x53D1;&#x751F;&#x6545;&#x969C;&#x4E4B;&#x540E;&#xFF0C;&#x4F1A;&#x4ECE;ISR&#x4E2D;&#x9009;&#x51FA;&#x4E00;&#x4E2A;&#x65B0;&#x7684;leader&#xFF1B;&#x4E4B;&#x540E;&#xFF0C;&#x4E3A;&#x4FDD;&#x8BC1;&#x591A;&#x4E2A;&#x526F;&#x672C;&#x4E4B;&#x95F4;&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x5176;&#x4F59;&#x7684;follower&#x4F1A;&#x5148;&#x5C06;&#x5404;&#x81EA;&#x7684;log&#x6587;&#x4EF6;&#x9AD8;&#x4E8E;HW&#x7684;&#x90E8;&#x5206;&#x622A;&#x6389;&#xFF0C;&#x7136;&#x540E;&#x4ECE;&#x65B0;&#x7684;leader&#x540C;&#x6B65;&#x6570;&#x636E;&#x3002;

&#x6CE8;&#x610F;&#xFF1A;&#x8FD9;&#x53EA;&#x80FD;&#x4FDD;&#x8BC1;&#x526F;&#x672C;&#x4E4B;&#x95F4;&#x7684;&#x6570;&#x636E;&#x4E00;&#x81F4;&#x6027;&#xFF0C;&#x5E76;&#x4E0D;&#x80FD;&#x4FDD;&#x8BC1;&#x6570;&#x636E;&#x4E0D;&#x4E22;&#x5931;&#x6216;&#x8005;&#x4E0D;&#x91CD;&#x590D;

### 0.11&#x7248;&#x672C;&#x4E4B;&#x540E; &#x5E42;&#x7B49; &amp; Exactly Once &#x8BED;&#x4E49;

&#x5BF9;&#x4E8E;&#x67D0;&#x4E9B;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x7684;&#x6D88;&#x606F;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x4FDD;&#x8BC1;exactly once&#x8BED;&#x4E49;&#xFF0C;&#x5373;&#x4FDD;&#x8BC1;&#x6BCF;&#x6761;&#x6D88;&#x606F;&#x88AB;&#x53D1;&#x9001;&#x4E14;&#x4EC5;&#x88AB;&#x53D1;&#x9001;&#x4E00;&#x6B21;&#x3002;

&#x5728;0.11&#x7248;&#x672C;&#x4E4B;&#x540E;&#xFF0C;Kafka Producer&#x5F15;&#x5165;&#x4E86;&#x5E42;&#x7B49;&#x6027;&#x673A;&#x5236;&#xFF08;`idempotent` n. &#x5E42;&#x7B49;&#x6027;&#xFF09;&#xFF0C;&#x914D;&#x5408;acks = -1&#x65F6;&#x7684;at least once&#x8BED;&#x4E49;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86;producer&#x5230;broker&#x7684;exactly once&#x8BED;&#x4E49;&#x3002;

`idempotent + at least once = exactly once`

&#x4F7F;&#x7528;&#x65F6;&#xFF0C;&#x53EA;&#x9700;&#x5C06;`enable.idempotence`&#x5C5E;&#x6027;&#x8BBE;&#x7F6E;&#x4E3A;true&#xFF08;kafka&#x4F1A;&#x81EA;&#x52A8;&#x5C06;`acks`&#x5C5E;&#x6027;&#x8BBE;&#x4E3A;-1&#xFF09;

#### &#x4E8B;&#x52A1;&#x5E94;&#x7528;&#x573A;&#x666F;

kafka&#x7684;&#x5E94;&#x7528;&#x573A;&#x666F;&#x7ECF;&#x5E38;&#x662F;&#x5E94;&#x7528;&#x5148;&#x6D88;&#x8D39;&#x4E00;&#x4E2A;topic&#xFF0C;&#x7136;&#x540E;&#x505A;&#x5904;&#x7406;&#x518D;&#x53D1;&#x5230;&#x53E6;&#x4E00;&#x4E2A;topic&#xFF0C;&#x8FD9;&#x4E2A;`consume-transform-produce`&#x8FC7;&#x7A0B;&#x9700;&#x8981;&#x653E;&#x5230;&#x4E00;&#x4E2A;&#x4E8B;&#x52A1;&#x91CC;&#x9762;&#xFF0C;&#x6BD4;&#x5982;&#x5728;&#x6D88;&#x606F;&#x5904;&#x7406;&#x6216;&#x8005;&#x53D1;&#x9001;&#x7684;&#x8FC7;&#x7A0B;&#x4E2D;&#x5982;&#x679C;&#x5931;&#x8D25;&#x4E86;&#xFF0C;&#x6D88;&#x8D39;&#x4F4D;&#x70B9;&#x4E5F;&#x4E0D;&#x80FD;&#x63D0;&#x4EA4;&#x3002;

#### &#x4E8B;&#x52A1;&#x5904;&#x7406;

producer&#x63D0;&#x4F9B;&#x4E86;`initTransactions`, `beginTransaction`, `sendOffsets`, `commitTransaction`, `abortTransaction` &#x4E94;&#x4E2A;&#x4E8B;&#x52A1;&#x65B9;&#x6CD5;&#x3002;

```java
import org.apache.kafka.clients.consumer.ConsumerRecord;
import org.apache.kafka.clients.consumer.ConsumerRecords;
import org.apache.kafka.clients.consumer.KafkaConsumer;
import org.apache.kafka.clients.consumer.OffsetAndMetadata;
import org.apache.kafka.clients.producer.KafkaProducer;
import org.apache.kafka.clients.producer.ProducerRecord;
import org.apache.kafka.clients.producer.RecordMetadata;
import org.apache.kafka.common.TopicPartition;

import java.util.Arrays;
import java.util.HashMap;
import java.util.Map;
import java.util.Properties;
import java.util.concurrent.Future;

public class consumeTransformProduce {
    private static Properties getProducerProps(){
        Properties props =  new Properties();
        props.put(&quot;bootstrap.servers&quot;, &quot;47.52.199.51:9092&quot;);
        props.put(&quot;retries&quot;, 3); // &#x91CD;&#x8BD5;&#x6B21;&#x6570;
        props.put(&quot;batch.size&quot;, 100); // &#x6279;&#x91CF;&#x53D1;&#x9001;&#x5927;&#x5C0F;
        props.put(&quot;buffer.memory&quot;, 33554432); // &#x7F13;&#x5B58;&#x5927;&#x5C0F;&#xFF0C;&#x6839;&#x636E;&#x672C;&#x673A;&#x5185;&#x5B58;&#x5927;&#x5C0F;&#x914D;&#x7F6E;
        props.put(&quot;linger.ms&quot;, 1000); // &#x53D1;&#x9001;&#x9891;&#x7387;&#xFF0C;&#x6EE1;&#x8DB3;&#x4EFB;&#x52A1;&#x4E00;&#x4E2A;&#x6761;&#x4EF6;&#x53D1;&#x9001;
        props.put(&quot;client.id&quot;, &quot;producer-syn-2&quot;); // &#x53D1;&#x9001;&#x7AEF;id,&#x4FBF;&#x4E8E;&#x7EDF;&#x8BA1;
        props.put(&quot;key.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;);
        props.put(&quot;value.serializer&quot;, &quot;org.apache.kafka.common.serialization.StringSerializer&quot;);
        props.put(&quot;transactional.id&quot;,&quot;producer-2&quot;); // &#x8BBE;&#x7F6E;&#x4E8B;&#x52A1;Id,&#x6BCF;&#x53F0;&#x673A;&#x5668;&#x552F;&#x4E00;
        props.put(&quot;enable.idempotence&quot;,true); // &#x8BBE;&#x7F6E;&#x5E42;&#x7B49;&#x6027;
        return props;
    }

    private static Properties getConsumerProps(){
        Properties props =  new Properties();
        props.put(&quot;bootstrap.servers&quot;, &quot;47.52.199.51:9092&quot;);
        props.put(&quot;group.id&quot;, &quot;test_3&quot;);
        props.put(&quot;session.timeout.ms&quot;, 30000);       // &#x5982;&#x679C;&#x5176;&#x8D85;&#x65F6;&#xFF0C;&#x5C06;&#x4F1A;&#x53EF;&#x80FD;&#x89E6;&#x53D1;rebalance&#x5E76;&#x8BA4;&#x4E3A;&#x5DF2;&#x7ECF;&#x6B7B;&#x53BB;&#xFF0C;&#x91CD;&#x65B0;&#x9009;&#x4E3E;Leader
        props.put(&quot;enable.auto.commit&quot;, &quot;false&quot;);      // &#x5F00;&#x542F;&#x81EA;&#x52A8;&#x63D0;&#x4EA4;
        props.put(&quot;auto.commit.interval.ms&quot;, &quot;1000&quot;); // &#x81EA;&#x52A8;&#x63D0;&#x4EA4;&#x65F6;&#x95F4;
        props.put(&quot;auto.offset.reset&quot;,&quot;earliest&quot;); // &#x4ECE;&#x6700;&#x65E9;&#x7684;offset&#x5F00;&#x59CB;&#x62C9;&#x53D6;&#xFF0C;latest:&#x4ECE;&#x6700;&#x8FD1;&#x7684;offset&#x5F00;&#x59CB;&#x6D88;&#x8D39;
        props.put(&quot;client.id&quot;, &quot;producer-syn-1&quot;); // &#x53D1;&#x9001;&#x7AEF;id,&#x4FBF;&#x4E8E;&#x7EDF;&#x8BA1;
        props.put(&quot;max.poll.records&quot;,&quot;100&quot;); // &#x6BCF;&#x6B21;&#x6279;&#x91CF;&#x62C9;&#x53D6;&#x6761;&#x6570;
        props.put(&quot;max.poll.interval.ms&quot;,&quot;1000&quot;);
        props.put(&quot;key.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);
        props.put(&quot;value.deserializer&quot;, &quot;org.apache.kafka.common.serialization.StringDeserializer&quot;);
        props.put(&quot;isolation.level&quot;,&quot;read_committed&quot;); // &#x8BBE;&#x7F6E;&#x9694;&#x79BB;&#x7EA7;&#x522B;
        return props;
    }
    public static void main(String[] args) {
        // &#x521B;&#x5EFA;&#x751F;&#x4EA7;&#x8005;
        KafkaProducer<string, string=""> producer = new KafkaProducer&lt;&gt;(getProducerProps());
        // &#x521B;&#x5EFA;&#x6D88;&#x8D39;&#x8005;
        KafkaConsumer<string, string=""> consumer = new KafkaConsumer&lt;&gt;(getConsumerProps());
        // &#x521D;&#x59CB;&#x5316;&#x4E8B;&#x52A1;
        producer.initTransactions();
        // &#x8BA2;&#x9605;&#x4E3B;&#x9898;
        consumer.subscribe(Arrays.asList(&quot;consumer-tran&quot;));
        for(;;){
            // &#x5F00;&#x542F;&#x4E8B;&#x52A1;
            producer.beginTransaction();
            // &#x63A5;&#x53D7;&#x6D88;&#x606F;
            ConsumerRecords<string, string=""> records = consumer.poll(500);
            // &#x5904;&#x7406;&#x903B;&#x8F91;
            try {
                Map<topicpartition, offsetandmetadata=""> commits = new HashMap&lt;&gt;();
                for(ConsumerRecord record : records){
                    // &#x5904;&#x7406;&#x6D88;&#x606F;
                    System.out.printf(&quot;offset = %d, key = %s, value = %s\n&quot;, record.offset(), record.key(), record.value());
                    // &#x8BB0;&#x5F55;&#x63D0;&#x4EA4;&#x7684;&#x504F;&#x79FB;&#x91CF;
                    commits.put(new TopicPartition(record.topic(), record.partition()),new OffsetAndMetadata(record.offset()));
                    // &#x4EA7;&#x751F;&#x65B0;&#x6D88;&#x606F;
                    Future<recordmetadata> metadataFuture = producer.send(new ProducerRecord&lt;&gt;(&quot;consumer-send&quot;,record.value()+&quot;send&quot;));
                }
                // &#x63D0;&#x4EA4;&#x504F;&#x79FB;&#x91CF;
                producer.sendOffsetsToTransaction(commits,&quot;group0323&quot;);
                // &#x4E8B;&#x52A1;&#x63D0;&#x4EA4;
                producer.commitTransaction();

            }catch (Exception e){
                e.printStackTrace();
                producer.abortTransaction();
            }
        }
    }
}
```

## KafkaProducer&#x6E90;&#x7801;

### KafkaProducer &#x4EA4;&#x4E92;&#x7B80;&#x56FE;

![](../imgs/kafka_producer_frame.png)

&#x6240;&#x4EE5;&#x91CD;&#x70B9;&#x8981;&#x5173;&#x5FC3;&#xFF1A;1. &#x5143;&#x6570;&#x636E;&#xFF0C;2. &#x6570;&#x636E;&#x5982;&#x4F55;&#x53D1;&#x9001;

&#x540C;&#x6B65;&#x53D1;&#x9001;&#x5982;&#x4E0B;&#x56FE;&#xFF1A;

![](../imgs/kafka_produce_sync.png)

### &#x6E90;&#x7801;&#x6D41;&#x7A0B;&#x56FE;

![](../imgs/producer3.png)

```java
KafkaProducer
    send
        doSend(ProducerRecord<k, v=""> record, Callback callback)
            waitOnMetadata() &#xFF08;&#x96C6;&#x7FA4;&#x548C;topic&#x5143;&#x4FE1;&#x606F;&#xFF09;
            serialize&#xFF08;serializedKey, serializedValue&#x6784;&#x9020;&#xFF09;
            partition() (&#x83B7;&#x53D6;&#x4E00;&#x4E2A;&#x5206;&#x533A;&#x53F7;)
            new TopicPartition
            ensureValidRecordSize() &#x6821;&#x9A8C;record&#x7684;size
            timestamp
            Callback
            accumulator.append()
                RecordAccumulator
                    private final ConcurrentMap<topicpartition, deque<producerbatch="">&gt; batches;
                     tryAppend(timestamp, key, value, headers, callback, dq);
            this.sender.wakeup();
                 sender thread run()
                    long pollTimeout = sendProducerData(now);
                         this.accumulator.drain()
                        this.accumulator.expiredBatches
                        sendProduceRequests(batches, now);
                            ClientRequest
                            client.send(clientRequest, now);
                    client.poll(pollTimeout, now);
                        NetworkClient poll()
                            this.selector.poll(Utils.min(timeout, metadataTimeout, requestTimeoutMs));
```

![](../imgs/producer1.png)

![](../imgs/producer2.png)

#### &#x5143;&#x6570;&#x636E;&#x4EA4;&#x4E92;

sender&#x4ECE;kafka&#x96C6;&#x7FA4;&#x83B7;&#x53D6;&#x4FE1;&#x606F;&#xFF0C;&#x7136;&#x540E;&#x66F4;&#x65B0;Metadata&#xFF1B;KafkaProducer&#x5148;&#x8BFB;&#x53D6;Metadata&#xFF0C;&#x7136;&#x540E;&#x624D;&#x80FD;&#x786E;&#x5B9A;&#x5F00;&#x59CB;&#x6D88;&#x606F;&#x5199;&#x5165;&#x6D41;&#x7A0B;

&#x53EF;&#x4EE5;&#x770B;&#x5230;Metadata&#x662F;&#x6709;&#x591A;&#x4E2A;&#x5BA2;&#x6237;&#x7AEF;&#x7EBF;&#x7A0B;(&#x5373;KafkaProducer&#x7EBF;&#x7A0B;)&#x8BFB;&#xFF0C;&#x4E00;&#x4E2A;sender&#x7EBF;&#x7A0B;&#x66F4;&#x65B0;&#xFF0C;&#x56E0;&#x6B64;&#x5B83;&#x5FC5;&#x987B;&#x662F;&#x7EBF;&#x7A0B;&#x5B89;&#x5168;&#x7684;&#xFF0C;&#x67E5;&#x770B;&#x6E90;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5176;&#x6240;&#x6709;&#x65B9;&#x6CD5;&#x90FD;&#x662F;&#x52A0;&#x4E0A;`synchronized`&#x5173;&#x952E;&#x5B57;&#x7684;

```java
/**
 * A class encapsulating some of the logic around metadata.
 * <p>
 * This class is shared by the client thread (for partitioning) and the background sender thread.
 *
 * Metadata is maintained for only a subset of topics, which can be added to over time. When we request metadata for a
 * topic we don&apos;t have any metadata for it will trigger a metadata update.
 * </p><p>
 * If topic expiry is enabled for the metadata, any topic that has not been used within the expiry interval
 * is removed from the metadata refresh set after an update. Consumers disable topic expiry since they explicitly
 * manage topics while producers rely on topic expiry to limit the refresh set.
 */
public final class Metadata {
    ...
    public synchronized Cluster fetch()
    public synchronized void add(String topic)
    public synchronized long timeToNextUpdate(long nowMs)
    public synchronized int requestUpdate()
    public synchronized boolean updateRequested()
    public synchronized void awaitUpdate(final int lastVersion, final long maxWaitMs)
    ...
}
```

* `org.apache.kafka.clients.producer.KafkaProducer#waitOnMetadata`

```java
/**
 * Wait for cluster metadata including partitions for the given topic to be available.
 * @param topic The topic we want metadata for
 * @param partition A specific partition expected to exist in metadata, or null if there&apos;s no preference
 * @param maxWaitMs The maximum time in ms for waiting on the metadata
 * @return The cluster containing topic metadata and the amount of time we waited in ms
 */
private ClusterAndWaitTime waitOnMetadata(String topic, Integer partition, long maxWaitMs) throws InterruptedException {
    /**
     * metadata&#x7EF4;&#x62A4;&#x4E86;topic&#x548C;&#x8FC7;&#x671F;&#x65F6;&#x95F4;&#x7684;Map&#x7ED3;&#x6784;(&#x5373; topic expiry)&#xFF1A;Map<string, long=""> topics;
     * add &#x4F1A;&#x5224;&#x65AD;&#x662F;&#x5426;&#x547D;&#x4E2D;&#x4E86;Map&#x4E14;&#x65F6;&#x95F4;&#x8FC7;&#x671F;&#x5224;&#x65AD;&#x5E76;&#x66F4;&#x65B0;&#xFF0C;&#x5426;&#x5219;&#x8981;&#x8FDB;&#x884C;Metadata&#x7684;&#x66F4;&#x65B0;&#xFF08;&#x7531;sender&#x7EBF;&#x7A0B;&#x8D1F;&#x8D23;&#x66F4;&#x65B0;&#xFF09;
     * &#x6CE8;&#xFF1A;add&#x65B9;&#x6CD5;&#x5728;&#x65B0;&#x589E;topic&#x65F6;&#x5019;&#x624D;&#x4F1A;`requestUpdateForNewTopics`&#xFF0C;&#x66F4;&#x65B0;&#x6807;&#x8BB0;&#xFF08;Metadata&#x7684;&#x6210;&#x5458;&#x5C5E;&#x6027;needUpdate&#xFF09;
     */
    // add topic to metadata topic list if it is not there already and reset expiry
    metadata.add(topic);
    Cluster cluster = metadata.fetch();
    Integer partitionsCount = cluster.partitionCountForTopic(topic);
    // Return cached metadata if we have it, and if the record&apos;s partition is either undefined
    // or within the known partition range
    // &#x6307;&#x5B9A;&#x5206;&#x533A;&#x7A7A;&#xFF0C;&#x6216;&#x8005;&#x662F;&#x5C0F;&#x4E8E;&#x5206;&#x533A;&#x603B;&#x6570;&#x7684;&#x548C;&#x5408;&#x7406;&#x503C;&#xFF0C;&#x5C31;&#x8FD4;&#x56DE;
    if (partitionsCount != null &amp;&amp; (partition == null || partition &lt; partitionsCount))
        return new ClusterAndWaitTime(cluster, 0);

    long begin = time.milliseconds();
    long remainingWaitMs = maxWaitMs;
    long elapsed;
    // Issue metadata requests until we have metadata for the topic or maxWaitTimeMs is exceeded.
    // In case we already have cached metadata for the topic, but the requested partition is greater
    // than expected, issue an update request only once. This is necessary in case the metadata
    // is stale and the number of partitions for this topic has increased in the meantime.
    do {
        // &#x9700;&#x8981;&#x66F4;&#x65B0;&#x5143;&#x6570;&#x636E;&#x4FE1;&#x606F;&#xFF0C;&#x5E76;&#x5524;&#x9192; sender &#x7EBF;&#x7A0B;&#xFF0C;&#x53BB;&#x5B8C;&#x6210;&#x5143;&#x6570;&#x636E;&#x66F4;&#x65B0;
        log.trace(&quot;Requesting metadata update for topic {}.&quot;, topic);
        metadata.add(topic);
        int version = metadata.requestUpdate();
        sender.wakeup();
        try {
            // &#x5F00;&#x59CB;&#x66F4;&#x65B0;&#x5143;&#x6570;&#x636E;&#xFF0C;&#x5426;&#x5219;&#x8981;&#x629B;&#x51FA; TimeoutException
            metadata.awaitUpdate(version, remainingWaitMs);
        } catch (TimeoutException ex) {
            // Rethrow with original maxWaitMs to prevent logging exception with remainingWaitMs
            throw new TimeoutException(&quot;Failed to update metadata after &quot; + maxWaitMs + &quot; ms.&quot;);
        }
        cluster = metadata.fetch();
        elapsed = time.milliseconds() - begin;
        if (elapsed &gt;= maxWaitMs)
            throw new TimeoutException(&quot;Failed to update metadata after &quot; + maxWaitMs + &quot; ms.&quot;);
        if (cluster.unauthorizedTopics().contains(topic))
            throw new TopicAuthorizationException(topic);
        remainingWaitMs = maxWaitMs - elapsed;
        partitionsCount = cluster.partitionCountForTopic(topic);
    } while (partitionsCount == null);

    if (partition != null &amp;&amp; partition &gt;= partitionsCount) {
        throw new KafkaException(
                String.format(&quot;Invalid partition given with record: %d is not in the range [0...%d).&quot;, partition, partitionsCount));
    }

    return new ClusterAndWaitTime(cluster, elapsed);
}
```

&#x5143;&#x6570;&#x636E;&#x90E8;&#x5206;&#x603B;&#x7ED3;

1. KafkaProducer&#x4E3B;&#x7EBF;&#x7A0B;&#x548C;sender&#x7EBF;&#x7A0B;&#x901A;&#x8FC7;wait/notify&#x540C;&#x6B65;&#x3002;&#x4E3B;&#x7EBF;&#x7A0B;&#x8D1F;&#x8D23;&#x53D1;&#x51FA;&#x66F4;&#x65B0;&#x4FE1;&#x53F7;&#x548C;&#x8BFB;&#x53D6;&#x5143;&#x6570;&#x636E;&#xFF0C;sender&#x7EBF;&#x7A0B;&#x8D1F;&#x8D23;&#x66F4;&#x65B0;&#x96C6;&#x7FA4;&#x5143;&#x6570;&#x636E;
2. &#x4E3A;&#x4E86;&#x907F;&#x514D;&#x9891;&#x7E41;&#x66F4;&#x65B0;&#x5143;&#x6570;&#x636E;&#x7ED9;&#x670D;&#x52A1;&#x7AEF;&#x9020;&#x6210;&#x538B;&#x529B;&#xFF0C;Metadata&#x4E24;&#x6B21;&#x66F4;&#x65B0;&#x65F6;&#x95F4;&#x95F4;&#x9694;&#x4E0D;&#x80FD;&#x5C0F;&#x4E8E;refreshBackOffMs&#x8BBE;&#x8BA1;
3. Metadata&#x4F7F;&#x7528;version&#x6765;&#x8868;&#x793A;&#x5143;&#x4FE1;&#x606F;&#x7684;&#x7248;&#x672C;&#xFF0C;&#x66F4;&#x65B0;&#x540E;&#x7248;&#x672C;&#x5C31;&#x52A0;1&#xFF0C;&#x901A;&#x8FC7;&#x6BD4;&#x8F83;&#x65B0;&#x65E7;&#x7248;&#x672C;&#x6765;&#x5224;&#x65AD;Metadata&#x662F;&#x5426;&#x66F4;&#x65B0;&#x5B8C;&#x6210;
4. Metadata&#x4E0D;&#x662F;&#x5B58;&#x653E;&#x6240;&#x6709;topic&#x4FE1;&#x606F;&#xFF0C;&#x800C;&#x662F;&#x7EF4;&#x62A4;&#x4F7F;&#x7528;&#x5230;&#x7684;topic&#x7684;&#x4FE1;&#x606F;

#### &#x5143;&#x6570;&#x636E;&#x66F4;&#x65B0;&#x91CD;&#x96BE;&#x70B9;

&#x5237;&#x65B0;metadata&#x5E76;&#x4E0D;&#x4EC5;&#x5728;&#x7B2C;&#x4E00;&#x6B21;&#x521D;&#x59CB;&#x5316;&#x65F6;&#x505A;&#x3002;&#x4E3A;&#x4E86;&#x80FD;&#x9002;&#x5E94;kafka broker&#x8FD0;&#x884C;&#x4E2D;&#x56E0;&#x4E3A;&#x5404;&#x79CD;&#x539F;&#x56E0;&#x6302;&#x6389;&#x3001;partition&#x6539;&#x53D8;&#x7B49;&#x53D8;&#x5316;&#xFF0C;eventHandler&#x4F1A;&#x5B9A;&#x671F;&#x7684;&#x518D;&#x53BB;&#x5237;&#x65B0;&#x4E00;&#x6B21;&#x8BE5;metadata&#xFF0C;&#x5237;&#x65B0;&#x7684;&#x95F4;&#x9694;&#x7528;&#x53C2;&#x6570;topic.metadata.refresh.interval.ms&#x5B9A;&#x4E49;&#xFF0C;&#x9ED8;&#x8BA4;&#x503C;&#x662F;10&#x5206;&#x949F;


* &#x8C03;&#x7528;send, &#x624D;&#x4F1A;&#x65B0;&#x5EFA;SyncProducer&#xFF0C;&#x53EA;&#x6709;&#x8C03;&#x7528;send&#x624D;&#x4F1A;&#x53BB;&#x5B9A;&#x671F;&#x5237;&#x65B0;metadata&#x5728;&#x6BCF;&#x6B21;&#x53D6;metadata&#x65F6;&#xFF0C;kafka&#x4F1A;&#x65B0;&#x5EFA;&#x4E00;&#x4E2A;SyncProducer&#x53BB;&#x53D6;metadata&#xFF0C;&#x903B;&#x8F91;&#x5904;&#x7406;&#x5B8C;&#x540E;&#x518D;close&#x3002;

* &#x6839;&#x636E;&#x5F53;&#x524D;SyncProducer(&#x4E00;&#x4E2A;Broker&#x7684;&#x8FDE;&#x63A5;)&#x53D6;&#x5F97;&#x7684;&#x6700;&#x65B0;&#x7684;&#x5B8C;&#x6574;&#x7684;metadata&#xFF0C;&#x5237;&#x65B0;ProducerPool&#x4E2D;&#x5230;broker&#x7684;&#x8FDE;&#x63A5;.&#x6BCF;10&#x5206;&#x949F;&#x7684;&#x5237;&#x65B0;&#x4F1A;&#x76F4;&#x63A5;&#x91CD;&#x65B0;&#x628A;&#x5230;&#x6BCF;&#x4E2A;broker&#x7684;socket&#x8FDE;&#x63A5;&#x91CD;&#x5EFA;&#xFF0C;&#x610F;&#x5473;&#x7740;&#x5728;&#x8FD9;&#x4E4B;&#x540E;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;&#x8BF7;&#x6C42;&#x4F1A;&#x6709;&#x51E0;&#x767E;&#x6BEB;&#x79D2;&#x7684;&#x5EF6;&#x8FDF;&#x3002;&#x5982;&#x679C;&#x4E0D;&#x60F3;&#x8981;&#x8BE5;&#x5EF6;&#x8FDF;&#xFF0C;&#x628A;topic.metadata.refresh.interval.ms&#x503C;&#x6539;&#x4E3A;-1&#xFF0C;&#x8FD9;&#x6837;&#x53EA;&#x6709;&#x5728;&#x53D1;&#x9001;&#x5931;&#x8D25;&#x65F6;&#xFF0C;&#x624D;&#x4F1A;&#x91CD;&#x65B0;&#x5237;&#x65B0;&#x3002;

* Kafka&#x7684;&#x96C6;&#x7FA4;&#x4E2D;&#x5982;&#x679C;&#x67D0;&#x4E2A;partition&#x6240;&#x5728;&#x7684;broker&#x6302;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x68C0;&#x67E5;&#x9519;&#x8BEF;&#x540E;&#x91CD;&#x542F;&#x91CD;&#x65B0;&#x52A0;&#x5165;&#x96C6;&#x7FA4;&#xFF0C;&#x624B;&#x52A8;&#x505A;rebalance&#xFF0C;producer&#x7684;&#x8FDE;&#x63A5;&#x4F1A;&#x518D;&#x6B21;&#x65AD;&#x6389;&#xFF0C;&#x76F4;&#x5230;rebalance&#x5B8C;&#x6210;&#xFF0C;&#x90A3;&#x4E48;&#x5237;&#x65B0;&#x540E;&#x53D6;&#x5230;&#x7684;&#x8FDE;&#x63A5;&#x7740;&#x4E2D;&#x5C31;&#x4F1A;&#x6709;&#x8FD9;&#x4E2A;&#x65B0;&#x52A0;&#x5165;&#x7684;broker&#x3002;

#### &#x5E8F;&#x5217;&#x5316;

Producer &#x7AEF;&#x4F1A;&#x5BF9; record &#x7684; key &#x548C; value &#x503C;&#x8FDB;&#x884C;&#x5E8F;&#x5217;&#x5316;&#x64CD;&#x4F5C;&#xFF0C;&#x90A3;&#x4E48;&#x663E;&#x7136;&#x4E5F;&#x4F1A;&#x5728; Consumer &#x7AEF;&#x518D;&#x8FDB;&#x884C;&#x76F8;&#x5E94;&#x7684;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#xFF1B;

Kafka &#x5185;&#x90E8;&#x63D0;&#x4F9B;&#x63D0;&#x4F9B;&#x4E86;&#x5E8F;&#x5217;&#x5316;&#x548C;&#x53CD;&#x5E8F;&#x5217;&#x5316;&#x7B97;&#x6CD5;

#### &#x8BA1;&#x7B97; record &#x8981;&#x53D1;&#x9001;&#x5230;&#x7684; partition&#xFF1F;

&#x672A;&#x6307;&#x5B9A;&#x5206;&#x533A;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x9ED8;&#x8BA4;&#x7684;&#x5206;&#x533A;&#x7B56;&#x7565;&#x5982;&#x4E0B;&#xFF1A;

* &#x5982;&#x679C;&#x6307;&#x5B9A;&#x4E86;partition&#x5C31;&#x7528;&#x6307;&#x5B9A;&#x7684;&#xFF0C;&#x5426;&#x5219;&#x6709;&#x4E00;&#x4E2A;partition&#x65B9;&#x6CD5;&#x6765;&#x8BA1;&#x7B97;

```java
/**
 * computes partition for given record.
 * if the record has partition returns the value otherwise
 * calls configured partitioner class to compute the partition.
 */
private int partition(ProducerRecord<k, v=""> record, byte[] serializedKey, byte[] serializedValue, Cluster cluster) {
    Integer partition = record.partition();
    return partition != null ?
            partition :
            partitioner.partition(
                    record.topic(), record.key(), serializedKey, record.value(), serializedValue, cluster);
}
```

* &#x6CA1;&#x6709;&#x6307;&#x660E; partition &#x503C;, &#x4F46;&#x6709; key &#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x5C06; key &#x7684; hash &#x503C;&#x4E0E; topic &#x7684; partition &#x6570;&#x8FDB;&#x884C;&#x53D6;&#x4F59;&#x5F97;&#x5230; partition &#x503C;&#xFF1B;
* &#x6CA1;&#x6709;&#x6307;&#x660E; partition &#x503C;, &#x4E14;&#x6CA1;&#x6709; key &#x503C;&#x7684;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&#x65F6;&#x968F;&#x673A;&#x751F;&#x6210;&#x4E00;&#x4E2A;&#x6574;&#x6570;&#xFF08;&#x540E;&#x9762;&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x5728;&#x8FD9;&#x4E2A;&#x6574;&#x6570;&#x4E0A;&#x81EA;&#x589E;&#xFF09;&#xFF0C;&#x5C06;&#x8FD9;&#x4E2A;&#x503C;&#x4E0E; topic &#x53EF;&#x7528;&#x7684; partition &#x603B;&#x6570;&#x53D6;&#x4F59;&#x5F97;&#x5230; partition &#x503C;&#xFF08;&#x5373; round-robin &#x7B97;&#x6CD5;&#xFF09;

```java
public int partition(String topic, Object key, byte[] keyBytes, Object value, byte[] valueBytes, Cluster cluster) {
    List<partitioninfo> partitions = cluster.partitionsForTopic(topic);
    int numPartitions = partitions.size();
    if (keyBytes == null) {// &#x6CA1;&#x6709;&#x6307;&#x5B9A; key &#x7684;&#x60C5;&#x51B5;&#x4E0B;
        int nextValue = nextValue(topic); // &#x7B2C;&#x4E00;&#x6B21;&#x7684;&#x65F6;&#x5019;&#x4EA7;&#x751F;&#x4E00;&#x4E2A;&#x968F;&#x673A;&#x6574;&#x6570;,&#x540E;&#x9762;&#x6BCF;&#x6B21;&#x8C03;&#x7528;&#x5728;&#x4E4B;&#x524D;&#x7684;&#x57FA;&#x7840;&#x4E0A;&#x81EA;&#x589E;;
        List<partitioninfo> availablePartitions = cluster.availablePartitionsForTopic(topic);
        // leader &#x4E0D;&#x4E3A; null,&#x5373;&#x4E3A;&#x53EF;&#x7528;&#x7684; partition
        if (availablePartitions.size() &gt; 0) {
            int part = Utils.toPositive(nextValue) % availablePartitions.size();
            return availablePartitions.get(part).partition();
        } else {
            return Utils.toPositive(nextValue) % numPartitions;
        }
    } else {// &#x6709; key &#x7684;&#x60C5;&#x51B5;&#x4E0B;,&#x4F7F;&#x7528; key &#x7684; hash &#x503C;&#x8FDB;&#x884C;&#x8BA1;&#x7B97;
        return Utils.toPositive(Utils.murmur2(keyBytes)) % numPartitions; // &#x9009;&#x62E9; key &#x7684; hash &#x503C;
    }
}

// &#x6839;&#x636E; topic &#x83B7;&#x53D6;&#x5BF9;&#x5E94;&#x7684;&#x6574;&#x6570;&#x53D8;&#x91CF;
private int nextValue(String topic) {
    AtomicInteger counter = topicCounterMap.get(topic);
    if (null == counter) { // &#x7B2C;&#x4E00;&#x6B21;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x968F;&#x673A;&#x4EA7;&#x751F;
        counter = new AtomicInteger(new Random().nextInt());
        AtomicInteger currentCounter = topicCounterMap.putIfAbsent(topic, counter);
        if (currentCounter != null) {
            counter = currentCounter;
        }
    }
    return counter.getAndIncrement(); // &#x540E;&#x9762;&#x518D;&#x8C03;&#x7528;&#x65F6;&#xFF0C;&#x6839;&#x636E;&#x4E4B;&#x524D;&#x7684;&#x7ED3;&#x679C;&#x81EA;&#x589E;
}
```

<font color="red">&#x5F53;&#x7136;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x5B9E;&#x73B0;`Partitioner`&#x63A5;&#x53E3;</font>

<h4 id="accumulatorappend">accumulator.append()</h4>
<h5 id="recordaccumulator">RecordAccumulator</h5>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * This class acts as a queue that accumulates records into {@link MemoryRecords}
 * instances to be sent to the server.
 * &lt;p&gt;
 * The accumulator uses a bounded amount of memory and append calls will block when that memory is exhausted, unless
 * this behavior is explicitly disabled.
 */</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token keyword">class</span> <span class="token class-name">RecordAccumulator</span> <span class="token punctuation">{</span>

    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Logger</span> log<span class="token punctuation">;</span>
    <span class="token comment">// RecordAccumulator&#x662F;&#x5426;&#x5173;&#x95ED;&#x7684;&#x6807;&#x5FD7;&#x4F4D;closed</span>
    <span class="token keyword">private</span> <span class="token keyword">volatile</span> <span class="token keyword">boolean</span> closed<span class="token punctuation">;</span>
    <span class="token comment">// flushes&#x8FC7;&#x7A0B;&#x8BA1;&#x6570;&#x5668;flushesInProgress</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> flushesInProgress<span class="token punctuation">;</span>
    <span class="token comment">// appends&#x8FC7;&#x7A0B;&#x8BA1;&#x6570;&#x5668;appendsInProgress</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AtomicInteger</span> appendsInProgress<span class="token punctuation">;</span>
    <span class="token comment">// &#x6279;&#x91CF;&#x5927;&#x5C0F;batchSize</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">int</span> batchSize<span class="token punctuation">;</span>
    <span class="token comment">// &#x538B;&#x7F29;&#x5668;&#x7C7B;&#x578B;CompressionType&#x5B9E;&#x4F8B;compression</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">CompressionType</span> compression<span class="token punctuation">;</span>
    <span class="token comment">// &#x5EF6;&#x8FDF;&#x65F6;&#x95F4;lingerMs</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> lingerMs<span class="token punctuation">;</span>
    <span class="token comment">// &#x91CD;&#x8BD5;&#x65F6;&#x95F4;retryBackoffMs</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token keyword">long</span> retryBackoffMs<span class="token punctuation">;</span>
    <span class="token comment">// &#x7F13;&#x51B2;&#x6C60;BufferPool&#x7C7B;&#x578B;&#x7684;free</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">BufferPool</span> free<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Time</span> time<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ApiVersions</span> apiVersions<span class="token punctuation">;</span>
    <span class="token comment">// TopicPartition&#x5230;RecordBatch&#x53CC;&#x7AEF;&#x961F;&#x5217;&#x7684;ConcurrentMap&#x96C6;&#x5408;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">ConcurrentMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches<span class="token punctuation">;</span>
    <span class="token comment">// &#x5904;&#x4E8E;&#x5B8C;&#x6210;&#x72B6;&#x6001;&#x7684;&#x6279;&#x91CF;&#x8BB0;&#x5F55;IncompleteRecordBatches&#x7C7B;&#x578B;&#x7684;incomplete</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">IncompleteBatches</span> incomplete<span class="token punctuation">;</span>
    <span class="token comment">// The following variables are only accessed by the sender thread, so we don&apos;t need to protect them.</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">&gt;</span></span> muted<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">int</span> drainIndex<span class="token punctuation">;</span>
    <span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">TransactionManager</span> transactionManager<span class="token punctuation">;</span>
</code></pre>
<p><img src="../imgs/producer4.png" alt=""></p>
<h5 id="append&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x7801;&#x6D41;&#x7A0B;">append&#x65B9;&#x6CD5;&#x7684;&#x6E90;&#x7801;&#x6D41;&#x7A0B;</h5>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * Add a record to the accumulator, return the append result
 * &lt;p&gt;
 * The append result will contain the future metadata, and flag for whether the appended batch is full or a new batch is created
 * &lt;p&gt;
 *
 * @param tp The topic/partition to which this record is being sent
 * @param timestamp The timestamp of the record
 * @param key The key for the record
 * @param value The value for the record
 * @param headers the Headers for the record
 * @param callback The user-supplied callback to execute when the request is complete
 * @param maxTimeToBlock The maximum time in milliseconds to block for buffer memory to be available
 */</span>
<span class="token keyword">public</span> <span class="token class-name">RecordAppendResult</span> <span class="token function">append</span><span class="token punctuation">(</span><span class="token class-name">TopicPartition</span> tp<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> timestamp<span class="token punctuation">,</span>
                                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> key<span class="token punctuation">,</span>
                                 <span class="token keyword">byte</span><span class="token punctuation">[</span><span class="token punctuation">]</span> value<span class="token punctuation">,</span>
                                 <span class="token class-name">Header</span><span class="token punctuation">[</span><span class="token punctuation">]</span> headers<span class="token punctuation">,</span>
                                 <span class="token class-name">Callback</span> callback<span class="token punctuation">,</span>
                                 <span class="token keyword">long</span> maxTimeToBlock<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">InterruptedException</span> <span class="token punctuation">{</span>
    <span class="token comment">// We keep track of the number of appending thread to make sure we do not miss batches in</span>
    <span class="token comment">// abortIncompleteBatches().</span>
    appendsInProgress<span class="token punctuation">.</span><span class="token function">incrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">ByteBuffer</span> buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>headers <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> headers <span class="token operator">=</span> <span class="token class-name">Record</span><span class="token punctuation">.</span>EMPTY_HEADERS<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">/**
         * &#x83B7;&#x53D6;(&#x6216;&#x521B;&#x5EFA;)&#x5BF9;&#x5E94;&#x7684;deque
         */</span>
        <span class="token comment">// check if we have an in-progress batch</span>
        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> <span class="token function">getOrCreateDeque</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot send after the producer is closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/**
             * &#x5C1D;&#x8BD5;&#x5F80;&#x961F;&#x5217;&#x6DFB;&#x52A0;&#x6570;&#x636E;
             *  &#x6570;&#x636E;&#x9700;&#x8981;&#x6DFB;&#x52A0;&#x5230;`ProducerBatch`&#x4E2D;&#xFF0C;&#x9700;&#x8981;&#x5185;&#x5B58;;&#x7B2C;&#x4E00;&#x6B21;&#x8FD8;&#x6CA1;&#x6709;`ProducerBatch`&#xFF0C;&#x4F1A;&#x5931;&#x8D25;
             */</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">/**
         * &#x8BA1;&#x7B97;&#x4E00;&#x4E2A;`ProducerBatch`&#x7684;&#x5927;&#x5C0F;&#xFF0C;&#x4ECE;`BufferPool`&#x7EBF;&#x7A0B;&#x6C60;&#x4E2D;&#x7533;&#x8BF7;,&#x9ED8;&#x8BA4;&#x7684;batchSize=16k
         *  &#x5982;&#x679C;&#x4E00;&#x4E2A;record&#x7684;&#x5927;&#x5C0F;&#x8D85;&#x8FC7;&#x4E86;&#x4E00;&#x4E2A;batchSize&#xFF0C;&#x90A3;&#x4E48;&#x4E00;&#x4E2A;record&#x5C31;&#x662F;&#x4E00;&#x4E2A;`ProducerBatch`,&#x6570;&#x636E;&#x4E00;&#x6761;&#x4E00;&#x6761;&#x7684;&#x53D1;&#x9001;
         */</span>
        <span class="token comment">// we don&apos;t have an in-progress record batch try to allocate a new batch</span>
        <span class="token keyword">byte</span> maxUsableMagic <span class="token operator">=</span> apiVersions<span class="token punctuation">.</span><span class="token function">maxUsableProduceMagic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">int</span> size <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">max</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>batchSize<span class="token punctuation">,</span> <span class="token class-name">AbstractRecords</span><span class="token punctuation">.</span><span class="token function">estimateSizeInBytesUpperBound</span><span class="token punctuation">(</span>maxUsableMagic<span class="token punctuation">,</span> compression<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Allocating a new {} byte message buffer for topic {} partition {}&quot;</span><span class="token punctuation">,</span> size<span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">topic</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> tp<span class="token punctuation">.</span><span class="token function">partition</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        buffer <span class="token operator">=</span> free<span class="token punctuation">.</span><span class="token function">allocate</span><span class="token punctuation">(</span>size<span class="token punctuation">,</span> maxTimeToBlock<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// Need to check if producer is closed again after grabbing the dequeue lock.</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>closed<span class="token punctuation">)</span>
                <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalStateException</span><span class="token punctuation">(</span><span class="token string">&quot;Cannot send after the producer is closed.&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/**
             * &#x7EE7;&#x7EED;&#x5C1D;&#x8BD5;&#x6DFB;&#x52A0;&#x5230;`ProducerBatch`&#x4E2D;
             *  &#x7B2C;&#x4E00;&#x6B21;&#x7533;&#x8BF7;&#x7684;&#x5185;&#x5B58;&#x8FD8;&#x6CA1;&#x6709;&#x751F;&#x6210;&#x4E00;&#x4E2A;`ProducerBatch`,&#x6240;&#x4EE5;append&#x8FD8;&#x662F;&#x4F1A;&#x5931;&#x8D25;
              */</span>
            <span class="token class-name">RecordAppendResult</span> appendResult <span class="token operator">=</span> <span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> dq<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>appendResult <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// Somebody else found us a batch, return the one we waited for! Hopefully this doesn&apos;t happen often...</span>
                <span class="token keyword">return</span> appendResult<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token comment">/**
             * &#x53BB;&#x521B;&#x5EFA;`ProducerBatch`
             */</span>
            <span class="token class-name">MemoryRecordsBuilder</span> recordsBuilder <span class="token operator">=</span> <span class="token function">recordsBuilder</span><span class="token punctuation">(</span>buffer<span class="token punctuation">,</span> maxUsableMagic<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">ProducerBatch</span> batch <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ProducerBatch</span><span class="token punctuation">(</span>tp<span class="token punctuation">,</span> recordsBuilder<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token comment">/**
             * &#x7EE7;&#x7EED;&#x5C1D;&#x8BD5;&#x6DFB;&#x52A0;&#x5230;`ProducerBatch`&#x4E2D;
             */</span>
            <span class="token class-name">FutureRecordMetadata</span> future <span class="token operator">=</span> <span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">notNull</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">tryAppend</span><span class="token punctuation">(</span>timestamp<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">,</span> headers<span class="token punctuation">,</span> callback<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">/**
             * `ProducerBatch`&#x653E;&#x5230;deque&#x7684;&#x5C3E;&#x90E8;
             */</span>
            dq<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
            incomplete<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token comment">// Don&apos;t deallocate this buffer in the finally block as it&apos;s being used in the record batch</span>
            buffer <span class="token operator">=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>

            <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">RecordAppendResult</span><span class="token punctuation">(</span>future<span class="token punctuation">,</span> dq<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&gt;</span> <span class="token number">1</span> <span class="token operator">||</span> batch<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">finally</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>buffer <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">)</span>
            free<span class="token punctuation">.</span>dea <span class="token function">llocate</span><span class="token punctuation">(</span>buffer<span class="token punctuation">)</span><span class="token punctuation">;</span>
        appendsInProgress<span class="token punctuation">.</span><span class="token function">decrementAndGet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h4 id="sender&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x6D41;&#x7A0B;">sender&#x7EBF;&#x7A0B;&#x5904;&#x7406;&#x6D41;&#x7A0B;</h4>
<p><img src="../imgs/sender1.png" alt=""></p>
<ul>
<li>&#x6CE8;&#xFF1A;&#x5728;<code>new KafkaProducer&lt;&gt;(props);</code>&#x7684;&#x65F6;&#x5019;&#x4F1A;&#x542F;&#x52A8;sender&#x7EBF;&#x7A0B;</li>
</ul>
<h5 id="sender&#x6E90;&#x7801;">sender&#x6E90;&#x7801;</h5>
<pre class="language-"><code class="lang-java"><span class="token class-name">Sender</span> 
    run
        sendProducerData
            <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
             <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span>drain
            sensors<span class="token punctuation">.</span><span class="token function">updateProduceRequestMetrics</span><span class="token punctuation">(</span>batches<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">sendProduceRequests</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
        client<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span>pollTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
            metadataUpdater<span class="token punctuation">.</span><span class="token function">maybeUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">NetworkClient</span> <span class="token function">maybeUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> metadataTimeout<span class="token punctuation">,</span> requestTimeoutMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre>
<h5 id="sendproducerdata">sendProducerData</h5>
<pre class="language-"><code class="lang-java"><span class="token keyword">private</span> <span class="token keyword">long</span> <span class="token function">sendProducerData</span><span class="token punctuation">(</span><span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * &#x83B7;&#x53D6;&#x5230;&#x5F53;&#x524D;&#x7684;&#x96C6;&#x7FA4;&#x4FE1;&#x606F;
     */</span>
    <span class="token class-name">Cluster</span> cluster <span class="token operator">=</span> metadata<span class="token punctuation">.</span><span class="token function">fetch</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">/**
     * &#x83B7;&#x53D6;&#x5F53;&#x524D;&#x51C6;&#x5907;&#x53D1;&#x9001;&#x7684;partition(&#x6BCF;&#x4E2A;partition&#x6709;&#x4E00;&#x4E2A;leader broker&#xFF0C; &#x6CA1;&#x6709;&#x5219;&#x8981;&#x66F4;&#x65B0;&#x5143;&#x6570;&#x636E;&#x4FE1;&#x606F;)
     *
     * ready&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;
     * 1. &#x54EA;&#x4E9B;TopicPartition&#x6240;&#x5BF9;&#x5E94;&#x7684;Node&#x8282;&#x70B9;&#x662F;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x4FE1;&#x606F;&#x7684;&#x3002;
     * 2. &#x4E0B;&#x6B21;&#x68C0;&#x67E5;&#x8282;&#x70B9;&#x662F;&#x5426;ready&#x7684;&#x65F6;&#x95F4;&#x3002;
     * 3. &#x54EA;&#x4E9B;TopicPartition&#x5BF9;&#x5E94;&#x7684;leader&#x627E;&#x4E0D;&#x5230;&#x3002;
     */</span>
    <span class="token comment">// get the list of partitions with data ready to send</span>
    <span class="token class-name">RecordAccumulator</span><span class="token punctuation">.</span><span class="token class-name">ReadyCheckResult</span> result <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// if there are any partitions whose leaders are not known yet, force metadata update</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// The set of topics with unknown leader contains topics with leader election pending as well as</span>
        <span class="token comment">// topics which may have expired. Add the topic again to metadata to ensure it is included</span>
        <span class="token comment">// and request metadata update, since there are messages to send to the topic.</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">String</span> topic <span class="token operator">:</span> result<span class="token punctuation">.</span>unknownLeaderTopics<span class="token punctuation">)</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>topic<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>metadata<span class="token punctuation">.</span><span class="token function">requestUpdate</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * NetworkClient&#x68C0;&#x67E5;broker leader&#x7F51;&#x7EDC;&#x8FDE;&#x63A5;&#x60C5;&#x51B5;&#xFF0C;&#x4E0D;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;Node&#x5C06;&#x4ECE;readyNodes&#x4E2D;&#x79FB;&#x9664;
     */</span>
    <span class="token comment">// remove any nodes we aren&apos;t ready to send to</span>
    <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Node</span><span class="token punctuation">&gt;</span></span> iter <span class="token operator">=</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Long</span><span class="token punctuation">.</span>MAX_VALUE<span class="token punctuation">;</span>
    <span class="token keyword">while</span> <span class="token punctuation">(</span>iter<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Node</span> node <span class="token operator">=</span> iter<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">ready</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            iter<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            notReadyTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>notReadyTimeout<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>client<span class="token punctuation">.</span><span class="token function">connectionDelay</span><span class="token punctuation">(</span>node<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &#x4E0A;&#x9762;&#x786E;&#x5B9A;&#x4E86;&#x54EA;&#x4E9B;broker leader&#x662F;&#x53EF;&#x4EE5;&#x53D1;&#x9001;&#x6570;&#x636E;&#x7684;&#xFF0C;&#x8C03;&#x7528;RecordAccumulator.drain()&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x53D6;&#x5F85;&#x53D1;&#x9001;&#x7684;&#x6D88;&#x606F;&#x96C6;&#x5408;
     * &#x8FD4;&#x56DE;&lt;brokerId, ProducerBatch&#x7684;list&#x96C6;&#x5408;&gt;&#x7684;&#x4E00;&#x4E2A;map&#x7ED3;&#x6784;&#xFF0C;&#x5E76;&#x8BBE;&#x7F6E;TopicPartition&#x4E3A;muted
     */</span>
    <span class="token comment">// create produce requests</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">,</span> <span class="token class-name">List</span><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> batches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">drain</span><span class="token punctuation">(</span>cluster<span class="token punctuation">,</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">,</span>
            <span class="token keyword">this</span><span class="token punctuation">.</span>maxRequestSize<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>guaranteeMessageOrder<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Mute all the partitions drained</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> batchList <span class="token operator">:</span> batches<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> batch <span class="token operator">:</span> batchList<span class="token punctuation">)</span>
                <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">mutePartition</span><span class="token punctuation">(</span>batch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/**
     * &#x5224;&#x65AD;&#x8FC7;&#x671F;&#x7684;ProducerBatch&#xFF0C;&#x518D;&#x8C03;&#x7528;failBatch()&#x65B9;&#x6CD5;&#xFF1A;&#x4F1A;&#x8C03;&#x7528; ProducerBatch &#x7684;done()&#x65B9;&#x6CD5;&#x53BB;&#x91CA;&#x653E;&#x7A7A;&#x95F4;
     */</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> expiredBatches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">expiredBatches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token comment">// Reset the producer id if an expired batch has previously been sent to the broker. Also update the metrics</span>
    <span class="token comment">// for expired batches. see the documentation of @TransactionState.resetProducerId to understand why</span>
    <span class="token comment">// we need to reset the producer id here.</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expiredBatches<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Expired {} batches in accumulator&quot;</span><span class="token punctuation">,</span> expiredBatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> expiredBatch <span class="token operator">:</span> expiredBatches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">failBatch</span><span class="token punctuation">(</span>expiredBatch<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> NO_TIMESTAMP<span class="token punctuation">,</span> expiredBatch<span class="token punctuation">.</span><span class="token function">timeoutException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionManager <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expiredBatch<span class="token punctuation">.</span><span class="token function">inRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token comment">// This ensures that no new batches are drained until the current in flight batches are fully resolved.</span>
            transactionManager<span class="token punctuation">.</span><span class="token function">markSequenceUnresolved</span><span class="token punctuation">(</span>expiredBatch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>

    sensors<span class="token punctuation">.</span><span class="token function">updateProduceRequestMetrics</span><span class="token punctuation">(</span>batches<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// If we have any nodes that are ready to send + have sendable data, poll with 0 timeout so this can immediately</span>
    <span class="token comment">// loop and try sending more data. Otherwise, the timeout is determined by nodes that have partitions with data</span>
    <span class="token comment">// that isn&apos;t yet sendable (e.g. lingering, backing off). Note that this specifically does not include nodes</span>
    <span class="token comment">// with sendable data that aren&apos;t ready to send since they would cause busy looping.</span>
    <span class="token keyword">long</span> pollTimeout <span class="token operator">=</span> <span class="token class-name">Math</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>result<span class="token punctuation">.</span>nextReadyCheckDelayMs<span class="token punctuation">,</span> notReadyTimeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Nodes with data ready to send: {}&quot;</span><span class="token punctuation">,</span> result<span class="token punctuation">.</span>readyNodes<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// if some partitions are already ready to be sent, the select time would be 0;</span>
        <span class="token comment">// otherwise if some partition already has some data accumulated but not ready yet,</span>
        <span class="token comment">// the select time will be the time difference between now and its linger expiry time;</span>
        <span class="token comment">// otherwise the select time will be the time difference between now and the metadata expiry time;</span>
        pollTimeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token comment">/**
     * &#x4F1A;&#x5C01;&#x88C5;&#x6210;ClientRequest&#xFF0C;&#x53D1;&#x9001;&#x5230;NetworkClient,&#x518D;&#x8C03;&#x7528;NetworkClient.send()&#x5C06;ClientRequest&#x5199;&#x5165;KafkaChannel&#x7684;send&#x5B57;&#x6BB5;
     */</span>
    <span class="token function">sendProduceRequests</span><span class="token punctuation">(</span>batches<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> pollTimeout<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="&#x8D85;&#x65F6;&#x6D88;&#x606F;&#x7684;&#x5904;&#x7406;">&#x8D85;&#x65F6;&#x6D88;&#x606F;&#x7684;&#x5904;&#x7406;</h5>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * &#x5224;&#x65AD;&#x8FC7;&#x671F;&#x7684;ProducerBatch&#xFF0C;&#x518D;&#x8C03;&#x7528;failBatch()&#x65B9;&#x6CD5;
 *  &#x4F1A;&#x8C03;&#x7528; ProducerBatch &#x7684;done()&#x65B9;&#x6CD5;&#x7ED3;&#x675F;request
 *  &#x4F1A;&#x8C03;&#x7528; accumulator.deallocate &#x53BB;&#x91CA;&#x653E;&#x5185;&#x5B58;
 */</span>
<span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> expiredBatches <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>accumulator<span class="token punctuation">.</span><span class="token function">expiredBatches</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>requestTimeout<span class="token punctuation">,</span> now<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token comment">// Reset the producer id if an expired batch has previously been sent to the broker. Also update the metrics</span>
<span class="token comment">// for expired batches. see the documentation of @TransactionState.resetProducerId to understand why</span>
<span class="token comment">// we need to reset the producer id here.</span>
<span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>expiredBatches<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Expired {} batches in accumulator&quot;</span><span class="token punctuation">,</span> expiredBatches<span class="token punctuation">.</span><span class="token function">size</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">ProducerBatch</span> expiredBatch <span class="token operator">:</span> expiredBatches<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">failBatch</span><span class="token punctuation">(</span>expiredBatch<span class="token punctuation">,</span> <span class="token operator">-</span><span class="token number">1</span><span class="token punctuation">,</span> NO_TIMESTAMP<span class="token punctuation">,</span> expiredBatch<span class="token punctuation">.</span><span class="token function">timeoutException</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>transactionManager <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> expiredBatch<span class="token punctuation">.</span><span class="token function">inRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// This ensures that no new batches are drained until the current in flight batches are fully resolved.</span>
        transactionManager<span class="token punctuation">.</span><span class="token function">markSequenceUnresolved</span><span class="token punctuation">(</span>expiredBatch<span class="token punctuation">.</span>topicPartition<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * Get a list of batches which have been sitting in the accumulator too long and need to be expired.
 */</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> <span class="token function">expiredBatches</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestTimeout<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> expiredBatches <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">Map</span><span class="token punctuation">.</span><span class="token class-name">Entry</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">TopicPartition</span><span class="token punctuation">,</span> <span class="token class-name">Deque</span><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> entry <span class="token operator">:</span> <span class="token keyword">this</span><span class="token punctuation">.</span>batches<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Deque</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> dq <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token class-name">TopicPartition</span> tp <span class="token operator">=</span> entry<span class="token punctuation">.</span><span class="token function">getKey</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// We only check if the batch should be expired if the partition does not have a batch in flight.</span>
        <span class="token comment">// This is to prevent later batches from being expired while an earlier batch is still in progress.</span>
        <span class="token comment">// Note that `muted` is only ever populated if `max.in.flight.request.per.connection=1` so this protection</span>
        <span class="token comment">// is only active in this case. Otherwise the expiration order is not guaranteed.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>muted<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>tp<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">synchronized</span> <span class="token punctuation">(</span>dq<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token comment">// iterate over the batches and expire them if they have been in the accumulator for more than requestTimeOut</span>
                <span class="token class-name">ProducerBatch</span> lastBatch <span class="token operator">=</span> dq<span class="token punctuation">.</span><span class="token function">peekLast</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token class-name">Iterator</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ProducerBatch</span><span class="token punctuation">&gt;</span></span> batchIterator <span class="token operator">=</span> dq<span class="token punctuation">.</span><span class="token function">iterator</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">while</span> <span class="token punctuation">(</span>batchIterator<span class="token punctuation">.</span><span class="token function">hasNext</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token class-name">ProducerBatch</span> batch <span class="token operator">=</span> batchIterator<span class="token punctuation">.</span><span class="token function">next</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token keyword">boolean</span> isFull <span class="token operator">=</span> batch <span class="token operator">!=</span> lastBatch <span class="token operator">||</span> batch<span class="token punctuation">.</span><span class="token function">isFull</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token comment">// Check if the batch has expired. Expired batches are closed by maybeExpire, but callbacks</span>
                    <span class="token comment">// are invoked after completing the iterations, since sends invoked from callbacks</span>
                    <span class="token comment">// may append more batches to the deque being iterated. The batch is deallocated after</span>
                    <span class="token comment">// callbacks are invoked.</span>
                    <span class="token comment">/**
                     * &#x5224;&#x65AD;&#x662F;&#x5426;&#x8D85;&#x65F6;&#xFF0C;&#x5E76;&#x4ECE;deque&#x4E2D;&#x5220;&#x9664;
                     */</span>
                    <span class="token keyword">if</span> <span class="token punctuation">(</span>batch<span class="token punctuation">.</span><span class="token function">maybeExpire</span><span class="token punctuation">(</span>requestTimeout<span class="token punctuation">,</span> retryBackoffMs<span class="token punctuation">,</span> now<span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lingerMs<span class="token punctuation">,</span> isFull<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                        expiredBatches<span class="token punctuation">.</span><span class="token function">add</span><span class="token punctuation">(</span>batch<span class="token punctuation">)</span><span class="token punctuation">;</span>
                        batchIterator<span class="token punctuation">.</span><span class="token function">remove</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
                        <span class="token comment">// Stop at the first batch that has not expired.</span>
                        <span class="token keyword">break</span><span class="token punctuation">;</span>
                    <span class="token punctuation">}</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> expiredBatches<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * A batch whose metadata is not available should be expired if one of the following is true:
 * &lt;ol&gt;
 *     &lt;li&gt; the batch is not in retry AND request timeout has elapsed after it is ready (full or linger.ms has reached).
 *     &lt;li&gt; the batch is in retry AND request timeout has elapsed after the backoff period ended.
 * &lt;/ol&gt;
 * This methods closes this batch and sets {@code expiryErrorMessage} if the batch has timed out.
 */</span>
<span class="token keyword">boolean</span> <span class="token function">maybeExpire</span><span class="token punctuation">(</span><span class="token keyword">int</span> requestTimeoutMs<span class="token punctuation">,</span> <span class="token keyword">long</span> retryBackoffMs<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">,</span> <span class="token keyword">long</span> lingerMs<span class="token punctuation">,</span> <span class="token keyword">boolean</span> isFull<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">/**
     * requestTimeoutMs &#x8BF7;&#x6C42;&#x53D1;&#x9001;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF0C;&#x9ED8;&#x8BA4; 30s
     * now &#x5F53;&#x524D;&#x65F6;&#x95F4;
     * this.lastAppendTime ProducerBatch &#x521B;&#x5EFA;&#x7684;&#x65F6;&#x95F4;&#xFF08;&#x4E5F;&#x5373;&#x4E0A;&#x4E00;&#x6B21;&#x91CD;&#x8BD5;&#x7684;&#x65F6;&#x95F4;&#xFF09;
     * now - this.lastAppendTime &#x5927;&#x4E8E; requestTimeoutMs &#x5219;&#x8BF4;&#x660E; &#x5F53;&#x524D; ProducerBatch &#x8D85;&#x65F6;&#x4E86;&#xFF0C;&#x8FD8;&#x672A;&#x53D1;&#x9001;&#x51FA;&#x53BB;
     * lingerMs ProducerBatch&#x6700;&#x591A;&#x7B49;&#x5F85;&#x7684;&#x65F6;&#x95F4;&#x4E00;&#x5B9A;&#x8981;&#x53D1;&#x9001;&#x51FA;&#x53BB;&#xFF0C;&#x9ED8;&#x8BA4;&#xFF1A;100ms
     * retryBackoffMs &#x91CD;&#x8BD5;&#x7684;&#x65F6;&#x95F4;&#x95F4;&#x9694;
     *
     * &#x6CA1;&#x8BBE;&#x7F6E;&#x91CD;&#x8BD5;&#xFF0C;&#x5E76;&#x4E14;&#x53D1;&#x9001;&#x6279;&#x6B21;&#xFF08;batch.size&#xFF09;&#x6EE1;&#x4E86;&#xFF0C;&#x5E76;&#x4E14;&#x914D;&#x7F6E;&#x8BF7;&#x6C42;&#x8D85;&#x65F6;&#x65F6;&#x95F4;&#xFF08;request.timeout.ms&#xFF09;&#x5C0F;&#x4E8E;&#x3010;&#x5F53;&#x524D;&#x65F6;&#x95F4;&#x51CF;&#x53BB;&#x6700;&#x540E;&#x8FFD;&#x52A0;&#x6279;&#x6B21;&#x7684;&#x65F6;&#x95F4;&#x3011;
     * &#x6CA1;&#x8BBE;&#x7F6E;&#x91CD;&#x8BD5;&#xFF0C;&#x5E76;&#x4E14; request.timeout.ms &#x5C0F;&#x4E8E;&#x3010;&#x521B;&#x5EFA;&#x6279;&#x6B21;&#x65F6;&#x95F4;&#x51CF;&#x53BB;&#x914D;&#x7F6E;&#x7684;&#x7B49;&#x5F85;&#x53D1;&#x9001;&#x7684;&#x65F6;&#x95F4;&#xFF08;linger.ms&#xFF09;&#x3011;
     * &#x8BBE;&#x7F6E;&#x91CD;&#x8BD5;&#xFF0C;&#x5E76;&#x4E14; request.timeout.ms &#x5C0F;&#x4E8E;&#x3010;&#x5F53;&#x524D;&#x65F6;&#x95F4;-&#x6700;&#x540E;&#x91CD;&#x8BD5;&#x65F6;&#x95F4;-&#x91CD;&#x8BD5;&#x9700;&#x8981;&#x7B49;&#x5F85;&#x7684;&#x65F6;&#x95F4;&#xFF08;retry.backoff.ms&#xFF09;&#x3011;
     */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">inRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> isFull <span class="token operator">&amp;&amp;</span> requestTimeoutMs <span class="token operator">&lt;</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppendTime<span class="token punctuation">)</span><span class="token punctuation">)</span>
        expiryErrorMessage <span class="token operator">=</span> <span class="token punctuation">(</span>now <span class="token operator">-</span> <span class="token keyword">this</span><span class="token punctuation">.</span>lastAppendTime<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms has passed since last append&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">inRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> requestTimeoutMs <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token function">createdTimeMs</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> lingerMs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        expiryErrorMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">createdTimeMs</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> lingerMs<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms has passed since batch creation plus linger time&quot;</span><span class="token punctuation">;</span>
    <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">inRetry</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> requestTimeoutMs <span class="token operator">&lt;</span> <span class="token punctuation">(</span><span class="token function">waitedTimeMs</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> retryBackoffMs<span class="token punctuation">)</span><span class="token punctuation">)</span>
        expiryErrorMessage <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token function">waitedTimeMs</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span> <span class="token operator">-</span> retryBackoffMs<span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token string">&quot; ms has passed since last attempt plus backoff time&quot;</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> expired <span class="token operator">=</span> expiryErrorMessage <span class="token operator">!=</span> <span class="token keyword">null</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>expired<span class="token punctuation">)</span>
        <span class="token function">abortRecordAppends</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> expired<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<h5 id="clientpoll">client.poll</h5>
<p>&#x8C03;&#x7528;<code>NetworkClient.poll()</code>&#x65B9;&#x6CD5;&#xFF0C;&#x5C06;KafkaChannel.send&#x5B57;&#x6BB5;&#x4E2D;&#x4FDD;&#x5B58;&#x7684;ClientRequest&#x53D1;&#x9001;&#x51FA;&#x53BB;&#xFF0C;&#x5E76;&#x4E14;&#x8FD8;&#x4F1A;&#x5904;&#x7406;&#x670D;&#x52A1;&#x7AEF;&#x53D1;&#x56DE;&#x7684;&#x54CD;&#x5E94;&#x3001;&#x5904;&#x7406;&#x8D85;&#x65F6;&#x7684;&#x8BF7;&#x6C42;&#x3001;&#x8C03;&#x7528;&#x7528;&#x6237;&#x81EA;&#x5B9A;&#x4E49;&#x7684;CallBack</p>
<ul>
<li>NetworkClient.poll()</li>
</ul>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * Do actual reads and writes to sockets.
 *
 * @param timeout The maximum amount of time to wait (in ms) for responses if there are none immediately,
 *                must be non-negative. The actual timeout will be the minimum of timeout, request timeout and
 *                metadata timeout
 * @param now The current time in milliseconds
 * @return The list of responses received
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">,</span> <span class="token keyword">long</span> now<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>abortedSends<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// If there are aborted sends because of unsupported version exceptions or disconnects,</span>
        <span class="token comment">// handle them immediately without waiting for Selector#poll.</span>
        <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">handleAbortedSends</span><span class="token punctuation">(</span>responses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token function">completeResponses</span><span class="token punctuation">(</span>responses<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">return</span> responses<span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> metadataTimeout <span class="token operator">=</span> metadataUpdater<span class="token punctuation">.</span><span class="token function">maybeUpdate</span><span class="token punctuation">(</span>now<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>selector<span class="token punctuation">.</span><span class="token function">poll</span><span class="token punctuation">(</span><span class="token class-name">Utils</span><span class="token punctuation">.</span><span class="token function">min</span><span class="token punctuation">(</span>timeout<span class="token punctuation">,</span> metadataTimeout<span class="token punctuation">,</span> requestTimeoutMs<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        log<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">&quot;Unexpected error during I/O&quot;</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">// process completed actions</span>
    <span class="token keyword">long</span> updatedNow <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">List</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">ClientResponse</span><span class="token punctuation">&gt;</span></span> responses <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">ArrayList</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleCompletedSends</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleCompletedReceives</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleDisconnections</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleConnections</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleInitiateApiVersionRequests</span><span class="token punctuation">(</span>updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">handleTimedOutRequests</span><span class="token punctuation">(</span>responses<span class="token punctuation">,</span> updatedNow<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">completeResponses</span><span class="token punctuation">(</span>responses<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">return</span> responses<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<ul>
<li>selector poll</li>
</ul>
<pre class="language-"><code class="lang-java"><span class="token comment">/**
 * Do whatever I/O can be done on each connection without blocking. This includes completing connections, completing
 * disconnections, initiating new sends, or making progress on in-progress sends or receives.
 *
 * When this call is completed the user can check for completed sends, receives, connections or disconnects using
 * {@link #completedSends()}, {@link #completedReceives()}, {@link #connected()}, {@link #disconnected()}. These
 * lists will be cleared at the beginning of each `poll` call and repopulated by the call if there is
 * any completed I/O.
 *
 * In the &quot;Plaintext&quot; setting, we are using socketChannel to read &amp; write to the network. But for the &quot;SSL&quot; setting,
 * we encrypt the data before we use socketChannel to write data to the network, and decrypt before we return the responses.
 * This requires additional buffers to be maintained as we are reading from network, since the data on the wire is encrypted
 * we won&apos;t be able to read exact no.of bytes as kafka protocol requires. We read as many bytes as we can, up to SSLEngine&apos;s
 * application buffer size. This means we might be reading additional bytes than the requested size.
 * If there is no further data to read from socketChannel selector won&apos;t invoke that channel and we&apos;ve have additional bytes
 * in the buffer. To overcome this issue we added &quot;stagedReceives&quot; map which contains per-channel deque. When we are
 * reading a channel we read as many responses as we can and store them into &quot;stagedReceives&quot; and pop one response during
 * the poll to add the completedReceives. If there are any active channels in the &quot;stagedReceives&quot; we set &quot;timeout&quot; to 0
 * and pop response and add to the completedReceives.
 *
 * Atmost one entry is added to &quot;completedReceives&quot; for a channel in each poll. This is necessary to guarantee that
 * requests from a channel are processed on the broker in the order they are sent. Since outstanding requests added
 * by SocketServer to the request queue may be processed by different request handler threads, requests on each
 * channel must be processed one-at-a-time to guarantee ordering.
 *
 * @param timeout The amount of time to wait, in milliseconds, which must be non-negative
 * @throws IllegalArgumentException If `timeout` is negative
 * @throws IllegalStateException If a send is given for which we have no existing connection or for which there is
 *         already an in-progress send
 */</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">poll</span><span class="token punctuation">(</span><span class="token keyword">long</span> timeout<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">IOException</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>timeout <span class="token operator">&lt;</span> <span class="token number">0</span><span class="token punctuation">)</span>
        <span class="token keyword">throw</span> <span class="token keyword">new</span> <span class="token class-name">IllegalArgumentException</span><span class="token punctuation">(</span><span class="token string">&quot;timeout should be &gt;= 0&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> madeReadProgressLastCall <span class="token operator">=</span> madeReadProgressLastPoll<span class="token punctuation">;</span>
    <span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">boolean</span> dataInBuffers <span class="token operator">=</span> <span class="token operator">!</span>keysWithBufferedRead<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">hasStagedReceives</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token operator">!</span>immediatelyConnectedKeys<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">(</span>madeReadProgressLastCall <span class="token operator">&amp;&amp;</span> dataInBuffers<span class="token punctuation">)</span><span class="token punctuation">)</span>
        timeout <span class="token operator">=</span> <span class="token number">0</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>memoryPool<span class="token punctuation">.</span><span class="token function">isOutOfMemory</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> outOfMemory<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">//we have recovered from memory pressure. unmute any channel not explicitly muted for other reasons</span>
        log<span class="token punctuation">.</span><span class="token function">trace</span><span class="token punctuation">(</span><span class="token string">&quot;Broker no longer low on memory - unmuting incoming sockets&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">for</span> <span class="token punctuation">(</span><span class="token class-name">KafkaChannel</span> channel <span class="token operator">:</span> channels<span class="token punctuation">.</span><span class="token function">values</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span>channel<span class="token punctuation">.</span><span class="token function">isInMutableState</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>explicitlyMutedChannels<span class="token punctuation">.</span><span class="token function">contains</span><span class="token punctuation">(</span>channel<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                channel<span class="token punctuation">.</span><span class="token function">unmute</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        outOfMemory <span class="token operator">=</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token comment">/* check ready keys */</span>
    <span class="token keyword">long</span> startSelect <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">int</span> numReadyKeys <span class="token operator">=</span> <span class="token function">select</span><span class="token punctuation">(</span>timeout<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">long</span> endSelect <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>selectTime<span class="token punctuation">.</span><span class="token keyword">record</span><span class="token punctuation">(</span>endSelect <span class="token operator">-</span> startSelect<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>numReadyKeys <span class="token operator">&gt;</span> <span class="token number">0</span> <span class="token operator">||</span> <span class="token operator">!</span>immediatelyConnectedKeys<span class="token punctuation">.</span><span class="token function">isEmpty</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">||</span> dataInBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> readyKeys <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>nioSelector<span class="token punctuation">.</span><span class="token function">selectedKeys</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// Poll from channels that have buffered data (but nothing more from the underlying socket)</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>dataInBuffers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            keysWithBufferedRead<span class="token punctuation">.</span><span class="token function">removeAll</span><span class="token punctuation">(</span>readyKeys<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//so no channel gets polled twice</span>
            <span class="token class-name">Set</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SelectionKey</span><span class="token punctuation">&gt;</span></span> toPoll <span class="token operator">=</span> keysWithBufferedRead<span class="token punctuation">;</span>
            keysWithBufferedRead <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HashSet</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">//poll() calls will repopulate if needed</span>
            <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span>toPoll<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token comment">// Poll from channels where the underlying socket has more data</span>
        <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span>readyKeys<span class="token punctuation">,</span> <span class="token boolean">false</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// Clear all selected keys so that they are included in the ready count for the next select</span>
        readyKeys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">pollSelectionKeys</span><span class="token punctuation">(</span>immediatelyConnectedKeys<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">,</span> endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>
        immediatelyConnectedKeys<span class="token punctuation">.</span><span class="token function">clear</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        madeReadProgressLastPoll <span class="token operator">=</span> <span class="token boolean">true</span><span class="token punctuation">;</span> <span class="token comment">//no work is also &quot;progress&quot;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">long</span> endIo <span class="token operator">=</span> time<span class="token punctuation">.</span><span class="token function">nanoseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>sensors<span class="token punctuation">.</span>ioTime<span class="token punctuation">.</span><span class="token keyword">record</span><span class="token punctuation">(</span>endIo <span class="token operator">-</span> endSelect<span class="token punctuation">,</span> time<span class="token punctuation">.</span><span class="token function">milliseconds</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// we use the time at the end of select to ensure that we don&apos;t close any connections that</span>
    <span class="token comment">// have just been processed in pollSelectionKeys</span>
    <span class="token function">maybeCloseOldestConnection</span><span class="token punctuation">(</span>endSelect<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token comment">// Add to completedReceives after closing expired connections to avoid removing</span>
    <span class="token comment">// channels with completed receives until all staged receives are completed.</span>
    <span class="token function">addToCompletedReceives</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre>
<p><footer class="page-footer"><span class="copyright">Copyright @doctording all right reserved&#xFF0C;powered by Gitbook</span><span class="footer-modification">&#x8BE5;&#x6587;&#x4EF6;&#x4FEE;&#x6539;&#x65F6;&#x95F4;&#xFF1A;
2020-12-20 12:58:43
</span></footer><div id="gitalk-container"></div><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://cdn.bootcss.com/blueimp-md5/2.12.0/js/md5.min.js"></script><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script></p>
</partitioninfo></partitioninfo></k,></string,></p></topicpartition,></k,></recordmetadata></topicpartition,></string,></string,></string,>
                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                
                <a href="producer2.html" class="navigation navigation-next navigation-unique" aria-label="Next page: 如何处理粘包/拆包问题">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"KafkaProducer","level":"1.4.1","depth":2,"next":{"title":"如何处理粘包/拆包问题","level":"1.4.2","depth":2,"path":"content/producer2.md","ref":"./content/producer2.md","articles":[]},"previous":{"title":"[kafka Producer]","level":"1.4","depth":1,"ref":"","articles":[{"title":"KafkaProducer","level":"1.4.1","depth":2,"path":"content/producer.md","ref":"./content/producer.md","articles":[]},{"title":"如何处理粘包/拆包问题","level":"1.4.2","depth":2,"path":"content/producer2.md","ref":"./content/producer2.md","articles":[]}]},"dir":"ltr"},"config":{"plugins":["prism","-highlight","-lunr","-search","-sharing","ace","codeblock-filename","search-plus","sectionx","splitter","tbfed-pagefooter","expandable-chapters","back-to-top-button","code","uml","page-treeview","gittalk"],"styles":{"website":"styles/website.css"},"pluginsConfig":{"tbfed-pagefooter":{"copyright":"Copyright @doctording","modify_label":"该文件修改时间：","modify_format":"YYYY-MM-DD HH:mm:ss"},"page-treeview":{"collapsed":false,"copyright":"Copyright @doctording","minHeaderCount":"2","minHeaderDeep":"2"},"prism":{},"ace":{},"splitter":{},"code":{"copyButtons":true},"fontsettings":{"theme":"white","family":"sans","size":2},"sectionx":{},"uml":{"format":"svg"},"codeblock-filename":{},"back-to-top-button":{},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"gittalk":{"clientID":"094729e19245d3fe84aa","clientSecret":"6c4cf7b48e7ae41c20d453c24eb9d5469e4d19fb","repo":"sword_at_offer","owner":"doctording","admin":["doctording"],"distractionFreeMode":false},"expandable-chapters":{},"search-plus":{}},"theme":"default","author":"doctording","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"java-note","language":"zh-hans","gitbook":"*","description":"kafka源码阅读"},"file":{"path":"content/producer.md","mtime":"2020-12-20T04:58:43.905Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2021-01-13T01:27:59.243Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-ace/ace/ace.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-ace/ace.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/jquery.mark.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search-plus/search.js"></script>
        
    
        
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sectionx/sectionx.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters/expandable-chapters.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-back-to-top-button/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-code/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-gittalk/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

